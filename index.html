<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Расписание</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .page {
            display: none;
        }
        .page.active {
            display: block;
        }
        .week-badge {
            font-size: 0.75rem;
            padding: 0.25rem 0.5rem;
            border-radius: 9999px;
            font-weight: 500;
            white-space: nowrap;
        }
        .week-badge.all {
            background-color: #d1d5db; /* gray-300 */
            color: #4b5563; /* gray-600 */
        }
        .week-badge.odd {
            background-color: #fca5a5; /* red-300 */
            color: #991b1b; /* red-800 */
        }
        .week-badge.even {
            background-color: #a5f3fc; /* cyan-300 */
            color: #0891b2; /* cyan-700 */
        }
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left-color: #4f46e5;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen p-4 flex flex-col items-center">

    <div class="bg-white p-6 md:p-10 rounded-3xl shadow-2xl w-full max-w-2xl">
        
        <div class="flex justify-between items-center mb-6 border-b pb-4">
            <button id="backButton" class="text-gray-500 hover:text-gray-700 transition-colors duration-200 p-2 rounded-full hidden">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
                </svg>
            </button>
            <h1 id="pageTitle" class="text-3xl font-bold text-gray-900">Расписание</h1>
            <button id="showAdminButton" class="text-gray-500 hover:text-gray-700 transition-colors duration-200 p-2 rounded-full">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.527.272 1.092.427 1.724 1.066z" />
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                </svg>
            </button>
        </div>

        <div id="pagesContainer">
            
            <div id="schedule_page" class="page active">
                <div class="mb-4 space-y-4">
                    <div class="space-y-2">
                        <label for="facultyFilter" class="block text-sm font-medium text-gray-700">Факультет:</label>
                        <select id="facultyFilter" class="w-full p-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-purple-500"></select>
                    </div>
                    <div class="space-y-2">
                        <label for="groupFilter" class="block text-sm font-medium text-gray-700">Группа:</label>
                        <select id="groupFilter" class="w-full p-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-purple-500"></select>
                    </div>
                    <div class="space-y-2">
                        <label for="dayFilter" class="block text-sm font-medium text-gray-700">День:</label>
                        <select id="dayFilter" class="w-full p-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-purple-500">
                            <option value="all">Вся неделя</option>
                            <option value="today">Сегодня</option>
                        </select>
                    </div>
                    <div class="space-y-2">
                        <label for="weekTypeFilter" class="block text-sm font-medium text-gray-700">Тип недели:</label>
                        <select id="weekTypeFilter" class="w-full p-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-purple-500">
                            <option value="all">Все</option>
                            <option value="even">Четная</option>
                            <option value="odd">Нечетная</option>
                        </select>
                    </div>
                </div>
                <div id="scheduleList" class="space-y-6">
                    <div class="flex items-center justify-center p-8">
                        <div class="spinner"></div>
                    </div>
                </div>
            </div>

            <div id="password_page" class="page">
                <div class="space-y-4">
                    <p class="text-gray-600 mb-6">Введите пароль для доступа к панели администратора.</p>
                    <input id="adminPasswordInput" type="password" placeholder="Пароль" class="w-full p-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-blue-500">
                    <button id="submitPasswordButton" class="w-full bg-blue-600 text-white font-semibold py-3 px-6 rounded-xl hover:bg-blue-700 transition-colors duration-200 shadow-md">
                        Войти
                    </button>
                </div>
            </div>

            <div id="admin_page" class="page">
                <p class="text-gray-600 mb-6">Панель администрирования. Здесь вы можете управлять данными.</p>
                <div class="space-y-4">
                    <button id="showFacultiesButton" class="w-full bg-blue-600 text-white font-semibold py-3 px-6 rounded-xl hover:bg-blue-700 transition-colors duration-200 shadow-md">
                        Управление факультетами
                    </button>
                    <button id="showGroupsButton" class="w-full bg-green-600 text-white font-semibold py-3 px-6 rounded-xl hover:bg-green-700 transition-colors duration-200 shadow-md">
                        Управление группами
                    </button>
                    <button id="showScheduleAdminButton" class="w-full bg-indigo-600 text-white font-semibold py-3 px-6 rounded-xl hover:bg-indigo-700 transition-colors duration-200 shadow-md">
                        Управление расписанием
                    </button>
                </div>
            </div>

            <div id="schedule_admin_page" class="page">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-semibold text-gray-800">Редактирование расписания</h2>
                    <button id="addScheduleEntryButton" class="bg-blue-500 text-white p-2 rounded-full hover:bg-blue-600 transition-colors duration-200 shadow-md">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
                        </svg>
                    </button>
                </div>
                <div class="space-y-2 mb-4">
                    <label for="groupSelect" class="block text-sm font-medium text-gray-700">Выберите группу:</label>
                    <select id="groupSelect" class="w-full p-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-purple-500"></select>
                </div>
                <div id="scheduleAdminList" class="space-y-6">
                    <p class="text-gray-500 text-center text-sm">Пожалуйста, выберите группу.</p>
                </div>
            </div>

            <div id="faculties_page" class="page">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-semibold text-gray-800">Список факультетов</h2>
                    <button id="addFacultyButton" class="bg-blue-500 text-white p-2 rounded-full hover:bg-blue-600 transition-colors duration-200 shadow-md">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
                        </svg>
                    </button>
                </div>
                <div id="facultiesList" class="space-y-4">
                    <p class="text-gray-500 text-center text-sm">Нет доступных факультетов.</p>
                </div>
            </div>

            <div id="groups_page" class="page">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-semibold text-gray-800">Список групп</h2>
                    <button id="addGroupButton" class="bg-blue-500 text-white p-2 rounded-full hover:bg-blue-600 transition-colors duration-200 shadow-md">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
                        </svg>
                    </button>
                </div>
                <div id="groupsList" class="space-y-4">
                    <p class="text-gray-500 text-center text-sm">Нет доступных групп.</p>
                </div>
            </div>

            <div id="faculty_edit_page" class="page">
                <h2 id="facultyFormTitle" class="text-2xl font-semibold text-gray-800 mb-4"></h2>
                <input id="facultyNameInput" type="text" placeholder="Название факультета" class="w-full p-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-blue-500 mb-4">
                <button id="saveFacultyButton" class="w-full bg-blue-600 text-white font-semibold py-3 px-6 rounded-xl hover:bg-blue-700 transition-colors duration-200 shadow-md">
                    Сохранить
                </button>

                <div id="facultyGroupsSection" class="mt-8 pt-4 border-t border-gray-200 hidden">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xl font-semibold text-gray-800">Группы факультета</h3>
                        <button id="addGroupsToFacultyButton" class="bg-green-500 text-white p-2 rounded-full hover:bg-green-600 transition-colors duration-200 shadow-md">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
                            </svg>
                        </button>
                    </div>
                    <div id="facultyGroupsList" class="space-y-2"></div>
                </div>
            </div>

            <div id="group_edit_page" class="page">
                <h2 id="groupFormTitle" class="text-2xl font-semibold text-gray-800 mb-4"></h2>
                <select id="groupFacultySelect" class="w-full p-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-purple-500">
                    <option value="">Выберите факультет</option>
                </select>
                <input id="groupNameInput" type="text" placeholder="Название группы" class="w-full p-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-blue-500 mb-4">
                <button id="saveGroupButton" class="w-full bg-blue-600 text-white font-semibold py-3 px-6 rounded-xl hover:bg-blue-700 transition-colors duration-200 shadow-md">
                    Сохранить
                </button>
            </div>
            
            <div id="addGroupsModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden">
                <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-xl bg-white">
                    <div class="mt-3 text-center">
                        <h3 class="text-lg leading-6 font-medium text-gray-900">Добавить группы</h3>
                        <div class="mt-2 px-7 py-3">
                            <div id="availableGroupsList" class="space-y-2"></div>
                        </div>
                        <div class="items-center px-4 py-3">
                            <button id="closeModalButton" class="px-4 py-2 bg-gray-200 text-gray-700 text-base font-medium rounded-xl hover:bg-gray-300 transition-colors duration-200 w-full">
                                Закрыть
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <div id="scheduleModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden">
                <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-xl bg-white">
                    <div class="mt-3 text-center">
                        <h3 id="scheduleModalTitle" class="text-lg leading-6 font-medium text-gray-900">Добавить занятие</h3>
                        <div class="mt-2 px-7 py-3 space-y-4">
                            <select id="scheduleDayInput" class="w-full p-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-purple-500">
                                <option value="Понедельник">Понедельник</option>
                                <option value="Вторник">Вторник</option>
                                <option value="Среда">Среда</option>
                                <option value="Четверг">Четверг</option>
                                <option value="Пятница">Пятница</option>
                                <option value="Суббота">Суббота</option>
                                <option value="Воскресенье">Воскресенье</option>
                            </select>
                            <input id="scheduleTimeInput" type="time" class="w-full p-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-blue-500">
                            <input id="scheduleSubjectInput" type="text" placeholder="Название предмета" class="w-full p-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-blue-500">
                            <select id="scheduleWeekTypeInput" class="w-full p-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-purple-500">
                                <option value="all">Для всех недель</option>
                                <option value="even">Четная неделя</option>
                                <option value="odd">Нечетная неделя</option>
                            </select>
                        </div>
                        <div class="items-center px-4 py-3">
                            <button id="saveScheduleEntryButton" class="px-4 py-2 bg-blue-600 text-white text-base font-medium rounded-xl hover:bg-blue-700 transition-colors duration-200 w-full mb-2">
                                Сохранить
                            </button>
                            <button id="closeScheduleModalButton" class="px-4 py-2 bg-gray-200 text-gray-700 text-base font-medium rounded-xl hover:bg-gray-300 transition-colors duration-200 w-full">
                                Отмена
                            </button>
                        </div>
                    </div>
                </div>
            </div>

        </div>

        <div id="messageBox" class="mt-8 p-4 rounded-xl text-center font-medium transition-opacity duration-300 opacity-0"></div>

    </div>

    <script type="module">
        // Глобальные переменные, предоставляемые средой Canvas
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // --- FIREBASE ИМПОРТЫ ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithCustomToken, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, doc, setDoc, deleteDoc, addDoc, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- ДАННЫЕ И СОСТОЯНИЕ ---
        let faculties = [];
        let groups = [];
        let schedule = [];
        let db;
        let auth;
        let userId;

        // --- СОСТОЯНИЕ НАВИГАЦИИ ---
        const pageHistory = ['schedule_page'];
        const pageTitle = document.getElementById('pageTitle');
        
        // --- DOM ЭЛЕМЕНТЫ ---
        const pages = document.querySelectorAll('.page');
        const showAdminButton = document.getElementById('showAdminButton');
        const backButton = document.getElementById('backButton');
        const facultiesList = document.getElementById('facultiesList');
        const groupsList = document.getElementById('groupsList');
        const scheduleList = document.getElementById('scheduleList');
        const facultyFilter = document.getElementById('facultyFilter');
        const groupFilter = document.getElementById('groupFilter');
        const dayFilter = document.getElementById('dayFilter');
        const weekTypeFilter = document.getElementById('weekTypeFilter');
        const facultyNameInput = document.getElementById('facultyNameInput');
        const groupNameInput = document.getElementById('groupNameInput');
        const groupFacultySelect = document.getElementById('groupFacultySelect');
        const facultyGroupsSection = document.getElementById('facultyGroupsSection');
        const facultyGroupsList = document.getElementById('facultyGroupsList');
        const addGroupsModal = document.getElementById('addGroupsModal');
        const availableGroupsList = document.getElementById('availableGroupsList');
        const adminPasswordInput = document.getElementById('adminPasswordInput');
        const messageBox = document.getElementById('messageBox');
        
        // Элементы админ-панели
        const showFacultiesButton = document.getElementById('showFacultiesButton');
        const showGroupsButton = document.getElementById('showGroupsButton');
        const showScheduleAdminButton = document.getElementById('showScheduleAdminButton');
        const addFacultyButton = document.getElementById('addFacultyButton');
        const addGroupButton = document.getElementById('addGroupButton');
        const addGroupsToFacultyButton = document.getElementById('addGroupsToFacultyButton');
        const saveFacultyButton = document.getElementById('saveFacultyButton');
        const saveGroupButton = document.getElementById('saveGroupButton');
        const closeModalButton = document.getElementById('closeModalButton');
        const submitPasswordButton = document.getElementById('submitPasswordButton');

        // Элементы админ-панели расписания
        const groupSelect = document.getElementById('groupSelect');
        const scheduleAdminList = document.getElementById('scheduleAdminList');
        const addScheduleEntryButton = document.getElementById('addScheduleEntryButton');
        const scheduleModal = document.getElementById('scheduleModal');
        const scheduleModalTitle = document.getElementById('scheduleModalTitle');
        const scheduleDayInput = document.getElementById('scheduleDayInput');
        const scheduleTimeInput = document.getElementById('scheduleTimeInput');
        const scheduleSubjectInput = document.getElementById('scheduleSubjectInput');
        const scheduleWeekTypeInput = document.getElementById('scheduleWeekTypeInput');
        const saveScheduleEntryButton = document.getElementById('saveScheduleEntryButton');
        const closeScheduleModalButton = document.getElementById('closeScheduleModalButton');

        // Текущее состояние для редактирования
        let currentFacultyId = null;
        let currentGroupId = null;
        let currentScheduleEntryId = null;

        // --- ИНТЕГРАЦИЯ С TELEGRAM WEB APP ---
        const WebApp = window.Telegram.WebApp;
        WebApp.ready();
        WebApp.onEvent('backButtonClicked', goBack);

        // --- ФУНКЦИИ ИНИЦИАЛИЗАЦИИ ---

        /**
         * Инициализирует Firebase и настраивает слушателей данных.
         */
        async function initializeAppAndAuth() {
            try {
                if (!firebaseConfig) {
                    console.error("Ошибка: Firebase-конфигурация отсутствует.");
                    showMessage("Ошибка инициализации приложения.", "error");
                    return;
                }

                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                // Проверяем, предоставлен ли пользовательский токен
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }

                // Используем onAuthStateChanged для отслеживания состояния аутентификации
                // Это гарантирует, что мы получим пользователя, прежде чем начнем работать с Firestore.
                // onAuthStateChanged вызывается один раз при загрузке, а затем при каждом изменении состояния.
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        // После успешного входа начинаем прослушивать данные
                        setupFirestoreListeners();
                    } else {
                        console.log("Пользователь не аутентифицирован.");
                    }
                });

            } catch (error) {
                console.error("Ошибка инициализации Firebase:", error);
                showMessage("Ошибка инициализации приложения.", "error");
            }
        }

        /**
         * Настраивает слушателей для коллекций Firestore.
         */
        function setupFirestoreListeners() {
            const facultyCollectionRef = collection(db, `artifacts/${appId}/public/data/faculties`);
            const groupCollectionRef = collection(db, `artifacts/${appId}/public/data/groups`);
            const scheduleCollectionRef = collection(db, `artifacts/${appId}/public/data/schedule`);

            onSnapshot(facultyCollectionRef, (snapshot) => {
                faculties = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderFaculties();
                renderGroupFacultySelect();
                renderFacultyAndGroupFilters();
            });

            onSnapshot(groupCollectionRef, (snapshot) => {
                groups = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderGroups();
                renderAvailableGroups();
                renderGroupSelect();
                renderFacultyAndGroupFilters();
            });

            onSnapshot(scheduleCollectionRef, (snapshot) => {
                schedule = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderSchedule();
                renderScheduleAdminList();
            });
        }

        // --- ФУНКЦИИ НАВИГАЦИИ ---

        /**
         * Отображает указанную страницу и управляет историей навигации.
         * @param {string} pageId Идентификатор страницы для отображения.
         */
        function showPage(pageId) {
            pages.forEach(page => page.classList.remove('active'));
            const targetPage = document.getElementById(pageId);
            if (targetPage) {
                targetPage.classList.add('active');
            }
            
            if (pageHistory[pageHistory.length - 1] !== pageId) {
                pageHistory.push(pageId);
            }
            
            updateNavigationUI();
        }

        /**
         * Возвращается к предыдущей странице в истории.
         */
        function goBack() {
            if (pageHistory.length > 1) {
                pageHistory.pop();
                const lastPageId = pageHistory[pageHistory.length - 1];
                pages.forEach(page => page.classList.remove('active'));
                const targetPage = document.getElementById(lastPageId);
                if (targetPage) {
                    targetPage.classList.add('active');
                }
                updateNavigationUI();
            } else {
                WebApp.close();
            }
        }

        /**
         * Обновляет элементы управления навигацией (кнопка "Назад" и заголовок страницы).
         */
        function updateNavigationUI() {
            if (pageHistory.length > 1) {
                WebApp.BackButton.show();
                showAdminButton.classList.add('hidden');
                backButton.classList.remove('hidden');
            } else {
                WebApp.BackButton.hide();
                showAdminButton.classList.remove('hidden');
                backButton.classList.add('hidden');
            }

            const currentPage = pageHistory[pageHistory.length - 1];
            switch (currentPage) {
                case 'schedule_page': pageTitle.textContent = 'Расписание'; break;
                case 'password_page': pageTitle.textContent = 'Вход'; break;
                case 'admin_page': pageTitle.textContent = 'Администрирование'; break;
                case 'faculties_page': pageTitle.textContent = 'Факультеты'; renderFaculties(); break;
                case 'groups_page': pageTitle.textContent = 'Группы'; renderGroups(); break;
                case 'schedule_admin_page': pageTitle.textContent = 'Редактирование расписания'; renderGroupSelect(); renderScheduleAdminList(); break;
                case 'faculty_edit_page': pageTitle.textContent = 'Редактирование факультета'; break;
                case 'group_edit_page': pageTitle.textContent = 'Редактирование группы'; break;
                default: pageTitle.textContent = 'Страница';
            }
        }
        
        /**
         * Отображает временное сообщение в нижней части экрана.
         * @param {string} message Текст сообщения.
         * @param {string} type Тип сообщения ('success' или 'error').
         */
        function showMessage(message, type) {
            messageBox.textContent = message;
            messageBox.classList.remove('opacity-0', 'bg-red-200', 'text-red-800', 'bg-green-200', 'text-green-800');
            if (type === 'success') {
                messageBox.classList.add('bg-green-200', 'text-green-800');
            } else if (type === 'error') {
                messageBox.classList.add('bg-red-200', 'text-red-800');
            }
            messageBox.classList.add('opacity-100');
            setTimeout(() => {
                messageBox.classList.remove('opacity-100');
                messageBox.classList.add('opacity-0');
            }, 3000);
        }

        // --- РЕНДЕРИНГ ЭЛЕМЕНТОВ ---

        /**
         * Рендерит список факультетов.
         */
        function renderFaculties() {
            facultiesList.innerHTML = '';
            if (faculties.length === 0) {
                facultiesList.innerHTML = `<p class="text-gray-500 text-center text-sm">Нет доступных факультетов.</p>`;
                return;
            }
            faculties.forEach(faculty => {
                const facultyGroupsCount = groups.filter(g => g.facultyId === faculty.id).length;
                const item = document.createElement('div');
                item.className = 'flex items-center justify-between bg-gray-50 p-4 rounded-xl shadow-sm';
                item.innerHTML = `
                    <div>
                        <h3 class="font-semibold text-gray-900">${faculty.name}</h3>
                        <p class="text-sm text-gray-500">${facultyGroupsCount} групп(а)</p>
                    </div>
                    <div>
                        <button class="edit-btn text-blue-500 hover:text-blue-700 font-medium transition-colors duration-200 mr-2" data-id="${faculty.id}">Редактировать</button>
                        <button class="delete-btn text-red-500 hover:text-red-700 font-medium transition-colors duration-200" data-id="${faculty.id}">Удалить</button>
                    </div>
                `;
                facultiesList.appendChild(item);
            });
        }

        /**
         * Рендерит список групп.
         */
        function renderGroups() {
            groupsList.innerHTML = '';
            if (groups.length === 0) {
                groupsList.innerHTML = `<p class="text-gray-500 text-center text-sm">Нет доступных групп.</p>`;
                return;
            }
            groups.forEach(group => {
                const faculty = faculties.find(f => f.id === group.facultyId);
                const facultyName = faculty ? faculty.name : 'Без факультета';
                const item = document.createElement('div');
                item.className = 'flex items-center justify-between bg-gray-50 p-4 rounded-xl shadow-sm';
                item.innerHTML = `
                    <div>
                        <h3 class="font-semibold text-gray-900">${group.name}</h3>
                        <p class="text-sm text-gray-500">${facultyName}</p>
                    </div>
                    <div>
                        <button class="edit-btn text-blue-500 hover:text-blue-700 font-medium transition-colors duration-200 mr-2" data-id="${group.id}">Редактировать</button>
                        <button class="delete-btn text-red-500 hover:text-red-700 font-medium transition-colors duration-200" data-id="${group.id}">Удалить</button>
                    </div>
                `;
                groupsList.appendChild(item);
            });
        }

        /**
         * Рендерит выпадающий список факультетов для редактирования группы.
         */
        function renderGroupFacultySelect() {
            groupFacultySelect.innerHTML = '<option value="">Выберите факультет</option>';
            faculties.forEach(faculty => {
                const option = document.createElement('option');
                option.value = faculty.id;
                option.textContent = faculty.name;
                groupFacultySelect.appendChild(option);
            });
        }

        /**
         * Рендерит список групп, привязанных к факультету.
         */
        function renderFacultyGroups() {
            facultyGroupsList.innerHTML = '';
            if (!currentFacultyId) return;

            const facultyGroups = groups.filter(g => g.facultyId === currentFacultyId);
            if (facultyGroups.length === 0) {
                facultyGroupsList.innerHTML = `<p class="text-gray-500 text-center text-sm">Нет групп, привязанных к этому факультету.</p>`;
                return;
            }

            facultyGroups.forEach(group => {
                const item = document.createElement('div');
                item.className = 'flex items-center justify-between bg-gray-50 p-4 rounded-xl shadow-sm';
                item.innerHTML = `
                    <h3 class="font-semibold text-gray-900">${group.name}</h3>
                    <button class="remove-group-btn text-red-500 hover:text-red-700 font-medium transition-colors duration-200" data-id="${group.id}">Отвязать</button>
                `;
                facultyGroupsList.appendChild(item);
            });
        }
        
        /**
         * Рендерит выпадающий список групп для админ-панели расписания.
         */
        function renderGroupSelect() {
            groupSelect.innerHTML = '<option value="">Выберите группу</option>';
            groups.forEach(group => {
                const option = document.createElement('option');
                option.value = group.id;
                option.textContent = group.name;
                groupSelect.appendChild(option);
            });
        }
        
        /**
         * Рендерит список доступных групп для модального окна добавления.
         */
        function renderAvailableGroups() {
            availableGroupsList.innerHTML = '';
            const unassignedGroups = groups.filter(g => !g.facultyId || g.facultyId !== currentFacultyId);
            if (unassignedGroups.length === 0) {
                availableGroupsList.innerHTML = `<p class="text-gray-500 text-center text-sm">Все группы уже привязаны.</p>`;
                return;
            }
            unassignedGroups.forEach(group => {
                const item = document.createElement('div');
                item.className = 'flex items-center justify-between bg-gray-50 p-3 rounded-xl shadow-sm';
                item.innerHTML = `
                    <h3 class="font-semibold text-gray-900">${group.name}</h3>
                    <button class="add-group-btn text-green-500 hover:text-green-700 font-medium transition-colors duration-200" data-id="${group.id}">Добавить</button>
                `;
                availableGroupsList.appendChild(item);
            });
        }

        /**
         * Рендерит список занятий в админ-панели расписания.
         */
        function renderScheduleAdminList() {
            const selectedGroupId = groupSelect.value;
            scheduleAdminList.innerHTML = '';
            if (!selectedGroupId) {
                scheduleAdminList.innerHTML = `<p class="text-gray-500 text-center text-sm">Пожалуйста, выберите группу.</p>`;
                return;
            }

            const groupSchedule = schedule.filter(s => s.groupId === selectedGroupId);
            if (groupSchedule.length === 0) {
                scheduleAdminList.innerHTML = `<p class="text-gray-500 text-center text-sm">Для этой группы нет занятий.</p>`;
                return;
            }
            
            // Сортируем по дню и времени
            const daysOrder = ["Понедельник", "Вторник", "Среда", "Четверг", "Пятница", "Суббота", "Воскресенье"];
            const sortedSchedule = groupSchedule.sort((a, b) => {
                const dayA = daysOrder.indexOf(a.day);
                const dayB = daysOrder.indexOf(b.day);
                if (dayA !== dayB) {
                    return dayA - dayB;
                }
                return a.time.localeCompare(b.time);
            });

            sortedSchedule.forEach(entry => {
                const item = document.createElement('div');
                item.className = 'flex items-center justify-between bg-gray-50 p-4 rounded-xl shadow-sm';
                item.innerHTML = `
                    <div>
                        <h3 class="font-semibold text-gray-900">${entry.subject}</h3>
                        <p class="text-sm text-gray-500">${entry.day} ${entry.time} <span class="week-badge ${entry.weekType}">${entry.weekType === 'odd' ? 'Нечетная' : entry.weekType === 'even' ? 'Четная' : 'Все'}</span></p>
                    </div>
                    <div>
                        <button class="edit-btn text-blue-500 hover:text-blue-700 font-medium transition-colors duration-200 mr-2" data-id="${entry.id}">Редактировать</button>
                        <button class="delete-btn text-red-500 hover:text-red-700 font-medium transition-colors duration-200" data-id="${entry.id}">Удалить</button>
                    </div>
                `;
                scheduleAdminList.appendChild(item);
            });
        }

        /**
         * Рендерит расписание для пользователя на основе фильтров.
         */
        function renderSchedule() {
            scheduleList.innerHTML = '';
            
            const selectedFacultyId = facultyFilter.value;
            const selectedGroupId = groupFilter.value;
            const selectedDay = dayFilter.value;
            const selectedWeekType = weekTypeFilter.value;
            const today = new Date().toLocaleDateString('ru-RU', { weekday: 'long' });

            if (!selectedGroupId) {
                scheduleList.innerHTML = `<p class="text-gray-500 text-center text-sm">Пожалуйста, выберите группу.</p>`;
                return;
            }
            
            const filteredSchedule = schedule.filter(entry => {
                const isGroupMatch = entry.groupId === selectedGroupId;
                const isDayMatch = selectedDay === 'all' || entry.day === today;
                const isWeekTypeMatch = selectedWeekType === 'all' || entry.weekType === 'all' || entry.weekType === selectedWeekType;
                return isGroupMatch && isDayMatch && isWeekTypeMatch;
            });

            if (filteredSchedule.length === 0) {
                scheduleList.innerHTML = `<p class="text-gray-500 text-center text-sm">Расписание не найдено.</p>`;
                return;
            }
            
            const sortedSchedule = filteredSchedule.sort((a, b) => a.time.localeCompare(b.time));

            sortedSchedule.forEach(entry => {
                const item = document.createElement('div');
                item.className = 'bg-white p-4 rounded-xl shadow-sm flex justify-between items-center';
                item.innerHTML = `
                    <div>
                        <h3 class="font-semibold text-gray-900">${entry.subject}</h3>
                        <p class="text-sm text-gray-500 mt-1">${entry.time} <span class="week-badge ${entry.weekType}">${entry.weekType === 'odd' ? 'Нечетная' : entry.weekType === 'even' ? 'Четная' : 'Все'}</span></p>
                    </div>
                    <div class="text-right">
                        <p class="text-sm text-gray-600">${entry.day}</p>
                    </div>
                `;
                scheduleList.appendChild(item);
            });
        }
        
        /**
         * Рендерит выпадающие списки факультетов и групп для фильтрации.
         */
        function renderFacultyAndGroupFilters() {
            // Очищаем и заполняем факультеты
            facultyFilter.innerHTML = '<option value="">Выберите факультет</option>';
            faculties.forEach(f => {
                const option = document.createElement('option');
                option.value = f.id;
                option.textContent = f.name;
                facultyFilter.appendChild(option);
            });

            // Очищаем и заполняем группы
            const selectedFacultyId = facultyFilter.value;
            const groupsToDisplay = selectedFacultyId
                ? groups.filter(g => g.facultyId === selectedFacultyId)
                : groups;

            groupFilter.innerHTML = '<option value="">Выберите группу</option>';
            groupsToDisplay.forEach(g => {
                const option = document.createElement('option');
                option.value = g.id;
                option.textContent = g.name;
                groupFilter.appendChild(option);
            });
        }

        // --- ОБРАБОТЧИКИ СОБЫТИЙ ---

        // Переключение на админ-панель
        showAdminButton.addEventListener('click', () => showPage('password_page'));
        backButton.addEventListener('click', goBack);

        // Вход в админ-панель
        submitPasswordButton.addEventListener('click', () => {
            const password = adminPasswordInput.value;
            // Здесь должна быть логика проверки пароля
            // Для примера просто используем статический пароль
            if (password === 'admin123') {
                showPage('admin_page');
                adminPasswordInput.value = '';
                showMessage("Вход выполнен успешно!", "success");
            } else {
                showMessage("Неверный пароль!", "error");
            }
        });

        // Навигация по админ-панели
        showFacultiesButton.addEventListener('click', () => showPage('faculties_page'));
        showGroupsButton.addEventListener('click', () => showPage('groups_page'));
        showScheduleAdminButton.addEventListener('click', () => showPage('schedule_admin_page'));

        // Добавление факультета
        addFacultyButton.addEventListener('click', () => {
            currentFacultyId = null;
            document.getElementById('facultyFormTitle').textContent = 'Новый факультет';
            facultyNameInput.value = '';
            facultyGroupsSection.classList.add('hidden');
            showPage('faculty_edit_page');
        });

        // Добавление группы
        addGroupButton.addEventListener('click', () => {
            currentGroupId = null;
            document.getElementById('groupFormTitle').textContent = 'Новая группа';
            groupNameInput.value = '';
            groupFacultySelect.value = '';
            showPage('group_edit_page');
        });

        // Редактирование/удаление факультета
        facultiesList.addEventListener('click', async (e) => {
            if (e.target.classList.contains('edit-btn')) {
                currentFacultyId = e.target.dataset.id;
                const facultyToEdit = faculties.find(f => f.id === currentFacultyId);
                if (facultyToEdit) {
                    document.getElementById('facultyFormTitle').textContent = 'Редактирование факультета';
                    facultyNameInput.value = facultyToEdit.name;
                    facultyGroupsSection.classList.remove('hidden');
                    renderFacultyGroups();
                    showPage('faculty_edit_page');
                }
            } else if (e.target.classList.contains('delete-btn')) {
                if (confirm('Вы уверены, что хотите удалить этот факультет?')) {
                    await deleteFaculty(e.target.dataset.id);
                }
            }
        });

        // Редактирование/удаление группы
        groupsList.addEventListener('click', async (e) => {
            if (e.target.classList.contains('edit-btn')) {
                currentGroupId = e.target.dataset.id;
                const groupToEdit = groups.find(g => g.id === currentGroupId);
                if (groupToEdit) {
                    document.getElementById('groupFormTitle').textContent = 'Редактирование группы';
                    groupNameInput.value = groupToEdit.name;
                    groupFacultySelect.value = groupToEdit.facultyId || '';
                    showPage('group_edit_page');
                }
            } else if (e.target.classList.contains('delete-btn')) {
                if (confirm('Вы уверены, что хотите удалить эту группу?')) {
                    await deleteGroup(e.target.dataset.id);
                }
            }
        });

        // Сохранение факультета
        saveFacultyButton.addEventListener('click', async () => {
            const name = facultyNameInput.value.trim();
            if (name) {
                if (currentFacultyId) {
                    await updateFaculty(currentFacultyId, name);
                } else {
                    await addFaculty(name);
                }
                goBack();
            } else {
                showMessage('Название факультета не может быть пустым.', 'error');
            }
        });

        // Сохранение группы
        saveGroupButton.addEventListener('click', async () => {
            const name = groupNameInput.value.trim();
            const facultyId = groupFacultySelect.value;
            if (name) {
                if (currentGroupId) {
                    await updateGroup(currentGroupId, name, facultyId);
                } else {
                    await addGroup(name, facultyId);
                }
                goBack();
            } else {
                showMessage('Название группы не может быть пустым.', 'error');
            }
        });
        
        // Открытие модального окна добавления групп к факультету
        addGroupsToFacultyButton.addEventListener('click', () => {
            renderAvailableGroups();
            addGroupsModal.classList.remove('hidden');
        });

        // Закрытие модального окна
        closeModalButton.addEventListener('click', () => {
            addGroupsModal.classList.add('hidden');
        });
        
        // Добавление/отвязка групп из модального окна
        addGroupsModal.addEventListener('click', async (e) => {
            const groupId = e.target.dataset.id;
            if (!groupId) return;

            if (e.target.classList.contains('add-group-btn')) {
                await updateGroup(groupId, groups.find(g => g.id === groupId).name, currentFacultyId);
                renderAvailableGroups();
                renderFacultyGroups();
            }
        });

        // Отвязка групп от факультета
        facultyGroupsList.addEventListener('click', async (e) => {
            const groupId = e.target.dataset.id;
            if (!groupId) return;

            if (e.target.classList.contains('remove-group-btn')) {
                await updateGroup(groupId, groups.find(g => g.id === groupId).name, null);
                renderFacultyGroups();
            }
        });

        // Выбор группы в админ-панели расписания
        groupSelect.addEventListener('change', () => {
            renderScheduleAdminList();
        });

        // Добавление занятия
        addScheduleEntryButton.addEventListener('click', () => {
            const selectedGroupId = groupSelect.value;
            if (!selectedGroupId) {
                showMessage('Пожалуйста, выберите группу.', 'error');
                return;
            }
            currentScheduleEntryId = null;
            scheduleModalTitle.textContent = 'Добавить занятие';
            scheduleDayInput.value = 'Понедельник';
            scheduleTimeInput.value = '';
            scheduleSubjectInput.value = '';
            scheduleWeekTypeInput.value = 'all';
            scheduleModal.classList.remove('hidden');
        });

        // Закрытие модального окна расписания
        closeScheduleModalButton.addEventListener('click', () => {
            scheduleModal.classList.add('hidden');
        });

        // Сохранение занятия
        saveScheduleEntryButton.addEventListener('click', async () => {
            const selectedGroupId = groupSelect.value;
            if (!selectedGroupId) {
                showMessage('Ошибка: группа не выбрана.', 'error');
                return;
            }

            const newEntry = {
                groupId: selectedGroupId,
                day: scheduleDayInput.value,
                time: scheduleTimeInput.value,
                subject: scheduleSubjectInput.value.trim(),
                weekType: scheduleWeekTypeInput.value,
            };

            if (newEntry.subject && newEntry.time) {
                if (currentScheduleEntryId) {
                    await updateScheduleEntry(currentScheduleEntryId, newEntry);
                } else {
                    await addScheduleEntry(newEntry);
                }
                scheduleModal.classList.add('hidden');
                renderScheduleAdminList();
            } else {
                showMessage('Пожалуйста, заполните все поля.', 'error');
            }
        });

        // Редактирование/удаление занятия
        scheduleAdminList.addEventListener('click', async (e) => {
            const entryId = e.target.dataset.id;
            if (!entryId) return;

            if (e.target.classList.contains('edit-btn')) {
                currentScheduleEntryId = entryId;
                const entryToEdit = schedule.find(s => s.id === entryId);
                if (entryToEdit) {
                    scheduleModalTitle.textContent = 'Редактировать занятие';
                    scheduleDayInput.value = entryToEdit.day;
                    scheduleTimeInput.value = entryToEdit.time;
                    scheduleSubjectInput.value = entryToEdit.subject;
                    scheduleWeekTypeInput.value = entryToEdit.weekType;
                    scheduleModal.classList.remove('hidden');
                }
            } else if (e.target.classList.contains('delete-btn')) {
                if (confirm('Вы уверены, что хотите удалить это занятие?')) {
                    await deleteScheduleEntry(entryId);
                }
            }
        });

        // Фильтрация расписания для пользователя
        facultyFilter.addEventListener('change', () => {
            const selectedFacultyId = facultyFilter.value;
            const groupsToDisplay = selectedFacultyId
                ? groups.filter(g => g.facultyId === selectedFacultyId)
                : groups;

            groupFilter.innerHTML = '<option value="">Выберите группу</option>';
            groupsToDisplay.forEach(g => {
                const option = document.createElement('option');
                option.value = g.id;
                option.textContent = g.name;
                groupFilter.appendChild(option);
            });
            renderSchedule();
        });

        groupFilter.addEventListener('change', renderSchedule);
        dayFilter.addEventListener('change', renderSchedule);
        weekTypeFilter.addEventListener('change', renderSchedule);
        
        // Запуск приложения
        initializeAppAndAuth();
        
    </script>
</body>
</html>
