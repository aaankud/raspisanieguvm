<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Управление Факультетами и Группами</title>
    <!-- Telegram Web App script is essential for mini-apps -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .page {
            display: none;
        }
        .page.active {
            display: block;
        }
        /* Style for the week type badge */
        .week-badge {
            font-size: 0.75rem;
            padding: 0.25rem 0.5rem;
            border-radius: 9999px;
            font-weight: 500;
            white-space: nowrap;
        }
        .week-badge.all {
            background-color: #d1d5db; /* gray-300 */
            color: #4b5563; /* gray-600 */
        }
        .week-badge.odd {
            background-color: #fca5a5; /* red-300 */
            color: #991b1b; /* red-800 */
        }
        .week-badge.even {
            background-color: #a5f3fc; /* cyan-300 */
            color: #0891b2; /* cyan-700 */
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen p-4 flex flex-col items-center">

    <!-- Main Container -->
    <div class="bg-white p-6 md:p-10 rounded-3xl shadow-2xl w-full max-w-2xl">
        
        <!-- Header with Title and Buttons -->
        <div class="flex justify-between items-center mb-6 border-b pb-4">
            <button id="backButton" class="text-gray-500 hover:text-gray-700 transition-colors duration-200 p-2 rounded-full hidden">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
                </svg>
            </button>
            <!-- NEW: Added button to go to Admin Home -->
            <button id="homeButton" class="text-gray-500 hover:text-gray-700 transition-colors duration-200 p-2 rounded-full hidden">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m0 0l2 2m-2-2v10a1 1 0 01-1 1h-3m-6-10v10a1 1 0 001 1h3m-8-2v4h4v-4m-4 0v4m4-4h4" />
                </svg>
            </button>
            <h1 id="pageTitle" class="text-3xl font-bold text-gray-900">Расписание</h1>
            <button id="showAdminButton" class="text-gray-500 hover:text-gray-700 transition-colors duration-200 p-2 rounded-full">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.527.272 1.092.427 1.724 1.066z" />
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                </svg>
            </button>
        </div>

        <!-- Pages Container -->
        <div id="pagesContainer">
            
            <!-- Schedule Page (Now the default page) -->
            <div id="schedule_page" class="page active">
                <div class="mb-4 space-y-4">
                    <div class="space-y-2">
                        <label for="facultyFilter" class="block text-sm font-medium text-gray-700">Факультет:</label>
                        <select id="facultyFilter" class="w-full p-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-purple-500">
                            <!-- Options populated by JS -->
                        </select>
                    </div>
                    <div class="space-y-2">
                        <label for="groupFilter" class="block text-sm font-medium text-gray-700">Группа:</label>
                        <select id="groupFilter" class="w-full p-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-purple-500">
                            <!-- Options populated by JS -->
                        </select>
                    </div>
                    <div class="space-y-2">
                        <label for="dayFilter" class="block text-sm font-medium text-gray-700">День:</label>
                        <select id="dayFilter" class="w-full p-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-purple-500">
                            <option value="all">Вся неделя</option>
                            <option value="today">Сегодня</option>
                        </select>
                    </div>
                    <div class="space-y-2">
                        <label for="weekTypeFilter" class="block text-sm font-medium text-gray-700">Тип недели:</label>
                        <select id="weekTypeFilter" class="w-full p-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-purple-500">
                            <option value="all">Все</option>
                            <option value="even">Четная</option>
                            <option value="odd">Нечетная</option>
                        </select>
                    </div>
                </div>
                <div id="scheduleList" class="space-y-6">
                    <!-- Schedule items will be rendered here -->
                </div>
            </div>

            <!-- Admin Password Page -->
            <div id="password_page" class="page">
                <div class="space-y-4">
                    <p class="text-gray-600 mb-6">Введите пароль для доступа к панели администратора.</p>
                    <input id="adminPasswordInput" type="password" placeholder="Пароль" class="w-full p-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-blue-500">
                    <button id="submitPasswordButton" class="w-full bg-blue-600 text-white font-semibold py-3 px-6 rounded-xl hover:bg-blue-700 transition-colors duration-200 shadow-md">
                        Войти
                    </button>
                </div>
            </div>

            <!-- Admin Home Page -->
            <div id="admin_page" class="page">
                <p class="text-gray-600 mb-6">Панель администрирования. Здесь вы можете управлять данными.</p>
                <div class="space-y-4">
                    <button id="showFacultiesButton" class="w-full bg-blue-600 text-white font-semibold py-3 px-6 rounded-xl hover:bg-blue-700 transition-colors duration-200 shadow-md">
                        Управление факультетами
                    </button>
                    <button id="showGroupsButton" class="w-full bg-green-600 text-white font-semibold py-3 px-6 rounded-xl hover:bg-green-700 transition-colors duration-200 shadow-md">
                        Управление группами
                    </button>
                    <button id="showScheduleAdminButton" class="w-full bg-indigo-600 text-white font-semibold py-3 px-6 rounded-xl hover:bg-indigo-700 transition-colors duration-200 shadow-md">
                        Управление расписанием
                    </button>
                    <!-- Button to show the code -->
                    <button id="showCodeButton" class="w-full bg-gray-600 text-white font-semibold py-3 px-6 rounded-xl hover:bg-gray-700 transition-colors duration-200 shadow-md">
                        Посмотреть код расписания
                    </button>
                </div>
            </div>

            <!-- NEW: Page to display the source code as JSON -->
            <div id="code_viewer_page" class="page">
                <div class="p-4 bg-gray-900 rounded-xl overflow-x-auto">
                    <pre id="codeDisplay" class="text-white text-sm leading-snug whitespace-pre-wrap font-mono"></pre>
                </div>
            </div>

            <!-- Schedule Admin Page -->
            <div id="schedule_admin_page" class="page">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-semibold text-gray-800">Редактирование расписания</h2>
                    <button id="addScheduleEntryButton" class="bg-blue-500 text-white p-2 rounded-full hover:bg-blue-600 transition-colors duration-200 shadow-md">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
                        </svg>
                    </button>
                </div>
                <div class="space-y-2 mb-4">
                    <label for="groupSelect" class="block text-sm font-medium text-gray-700">Выберите группу:</label>
                    <select id="groupSelect" class="w-full p-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-purple-500">
                        <!-- Options populated by JS -->
                    </select>
                </div>
                <div id="scheduleAdminList" class="space-y-6">
                    <!-- Schedule items will be rendered here -->
                </div>
            </div>

            <!-- Faculties List Page -->
            <div id="faculties_page" class="page">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-semibold text-gray-800">Список факультетов</h2>
                    <button id="addFacultyButton" class="bg-blue-500 text-white p-2 rounded-full hover:bg-blue-600 transition-colors duration-200 shadow-md">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
                        </svg>
                    </button>
                </div>
                <div id="facultiesList" class="space-y-4">
                    <!-- Faculty items will be rendered here -->
                </div>
            </div>

            <!-- Groups List Page -->
            <div id="groups_page" class="page">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-semibold text-gray-800">Список групп</h2>
                    <button id="addGroupButton" class="bg-blue-500 text-white p-2 rounded-full hover:bg-blue-600 transition-colors duration-200 shadow-md">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
                        </svg>
                    </button>
                </div>
                <div id="groupsList" class="space-y-4">
                    <!-- Group items will be rendered here -->
                </div>
            </div>

            <!-- Faculty Edit/Create Page -->
            <div id="faculty_edit_page" class="page">
                <h2 id="facultyFormTitle" class="text-2xl font-semibold text-gray-800 mb-4"></h2>
                <input id="facultyNameInput" type="text" placeholder="Название факультета" class="w-full p-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-blue-500 mb-4">
                <button id="saveFacultyButton" class="w-full bg-blue-600 text-white font-semibold py-3 px-6 rounded-xl hover:bg-blue-700 transition-colors duration-200 shadow-md">
                    Сохранить
                </button>

                <div id="facultyGroupsSection" class="mt-8 pt-4 border-t border-gray-200 hidden">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xl font-semibold text-gray-800">Группы факультета</h3>
                        <button id="addGroupsToFacultyButton" class="bg-green-500 text-white p-2 rounded-full hover:bg-green-600 transition-colors duration-200 shadow-md">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
                            </svg>
                        </button>
                    </div>
                    <div id="facultyGroupsList" class="space-y-2">
                        <!-- Groups in this faculty will be rendered here -->
                    </div>
                </div>
            </div>

            <!-- Group Edit/Create Page -->
            <div id="group_edit_page" class="page">
                <h2 id="groupFormTitle" class="text-2xl font-semibold text-gray-800 mb-4"></h2>
                <input id="groupNameInput" type="text" placeholder="Название группы" class="w-full p-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-blue-500 mb-4">
                <button id="saveGroupButton" class="w-full bg-blue-600 text-white font-semibold py-3 px-6 rounded-xl hover:bg-blue-700 transition-colors duration-200 shadow-md">
                    Сохранить
                </button>
            </div>
            
            <!-- Modal for adding groups to faculty -->
            <div id="addGroupsModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden">
                <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-xl bg-white">
                    <div class="mt-3 text-center">
                        <h3 class="text-lg leading-6 font-medium text-gray-900">Добавить группы</h3>
                        <div class="mt-2 px-7 py-3">
                            <div id="availableGroupsList" class="space-y-2">
                                <!-- Available groups will be rendered here -->
                            </div>
                        </div>
                        <div class="items-center px-4 py-3">
                            <button id="closeModalButton" class="px-4 py-2 bg-gray-200 text-gray-700 text-base font-medium rounded-xl hover:bg-gray-300 transition-colors duration-200 w-full">
                                Закрыть
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Modal for adding/editing schedule entry -->
            <div id="scheduleModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden">
                <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-xl bg-white">
                    <div class="mt-3 text-center">
                        <h3 id="scheduleModalTitle" class="text-lg leading-6 font-medium text-gray-900">Добавить занятие</h3>
                        <div class="mt-2 px-7 py-3 space-y-4">
                            <select id="scheduleDayInput" class="w-full p-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-purple-500">
                                <option value="Понедельник">Понедельник</option>
                                <option value="Вторник">Вторник</option>
                                <option value="Среда">Среда</option>
                                <option value="Четверг">Четверг</option>
                                <option value="Пятница">Пятница</option>
                                <option value="Суббота">Суббота</option>
                                <option value="Воскресенье">Воскресенье</option>
                            </select>
                            <input id="scheduleTimeInput" type="time" class="w-full p-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-blue-500">
                            <input id="scheduleSubjectInput" type="text" placeholder="Название предмета" class="w-full p-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-blue-500">
                            <select id="scheduleWeekTypeInput" class="w-full p-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-purple-500">
                                <option value="all">Для всех недель</option>
                                <option value="even">Четная неделя</option>
                                <option value="odd">Нечетная неделя</option>
                            </select>
                        </div>
                        <div class="items-center px-4 py-3">
                            <button id="saveScheduleEntryButton" class="px-4 py-2 bg-blue-600 text-white text-base font-medium rounded-xl hover:bg-blue-700 transition-colors duration-200 w-full mb-2">
                                Сохранить
                            </button>
                            <button id="closeScheduleModalButton" class="px-4 py-2 bg-gray-200 text-gray-700 text-base font-medium rounded-xl hover:bg-gray-300 transition-colors duration-200 w-full">
                                Отмена
                            </button>
                        </div>
                    </div>
                </div>
            </div>

        </div>

        <!-- Status Message Box -->
        <div id="messageBox" class="mt-8 p-4 rounded-xl text-center font-medium transition-opacity duration-300 opacity-0"></div>

    </div>

    <script>
        // --- DATA AND STATE MANAGEMENT ---
        const ADMIN_PASSWORD = 'admin'; // Хардкодный пароль для демонстрации
        
        // Массивы данных, которые будут имитировать хранилище
        let faculties = [
            { id: 1, name: 'Факультет ветеринарной медицины' },
            { id: 2, name: 'Факультет водных биоресурсов и аквакультуры' }
        ];
        let groups = [
            { id: 101, name: 'Группа-1', facultyId: 1 },
            { id: 102, name: 'Группа-2', facultyId: 1 },
            { id: 103, name: 'Группа-1', facultyId: 2 },
            { id: 104, name: 'Группа-2', facultyId: null }
        ];

        // Пример данных расписания с добавлением типа недели
        let schedule = [
            { id: 1, day: 'Понедельник', time: '09:00', subject: 'Математика', group: 'Группа-1', weekType: 'all' },
            { id: 2, day: 'Понедельник', time: '11:00', subject: 'Физика', group: 'Группа-2', weekType: 'all' },
            { id: 3, day: 'Вторник', time: '10:00', subject: 'Экономическая теория', group: 'Группа-1', weekType: 'even' },
            { id: 4, day: 'Среда', time: '13:00', subject: 'Основы программирования', group: 'Группа-1', weekType: 'all' },
            { id: 5, day: 'Среда', time: '15:00', subject: 'История', group: 'Группа-2', weekType: 'odd' },
            { id: 6, day: 'Четверг', time: '09:00', subject: 'Линейная алгебра', group: 'Группа-1', weekType: 'even' },
            { id: 7, day: 'Четверг', time: '11:00', subject: 'Базы данных', group: 'Группа-1', weekType: 'odd' },
            { id: 8, day: 'Пятница', time: '14:00', subject: 'Проектный менеджмент', group: 'Группа-2', weekType: 'all' },
            { id: 9, day: 'Вторник', time: '10:00', subject: 'Высшая математика', group: 'Группа-1', weekType: 'odd' },
            { id: 10, day: 'Вторник', time: '13:00', subject: 'История искусств', group: 'Группа-1', weekType: 'even' }
        ];

        let currentFacultyId = null;
        let currentGroupId = null;
        let currentScheduleEntryId = null;

        // --- NAVIGATION STATE ---
        const pageHistory = ['schedule_page'];
        const pageTitle = document.getElementById('pageTitle');
        
        // --- DOM ELEMENTS ---
        const pages = document.querySelectorAll('.page');
        const showAdminButton = document.getElementById('showAdminButton');
        const showScheduleAdminButton = document.getElementById('showScheduleAdminButton');
        const backButton = document.getElementById('backButton');
        const homeButton = document.getElementById('homeButton'); // NEW
        const facultiesList = document.getElementById('facultiesList');
        const groupsList = document.getElementById('groupsList');
        const scheduleList = document.getElementById('scheduleList');
        const facultyFilter = document.getElementById('facultyFilter');
        const groupFilter = document.getElementById('groupFilter');
        const dayFilter = document.getElementById('dayFilter');
        const weekTypeFilter = document.getElementById('weekTypeFilter');
        const facultyNameInput = document.getElementById('facultyNameInput');
        const groupNameInput = document.getElementById('groupNameInput');
        const facultyGroupsSection = document.getElementById('facultyGroupsSection');
        const facultyGroupsList = document.getElementById('facultyGroupsList');
        const addGroupsModal = document.getElementById('addGroupsModal');
        const availableGroupsList = document.getElementById('availableGroupsList');
        const adminPasswordInput = document.getElementById('adminPasswordInput');
        const messageBox = document.getElementById('messageBox');
        
        // Элементы управления расписанием
        const groupSelect = document.getElementById('groupSelect');
        const scheduleAdminList = document.getElementById('scheduleAdminList');
        const addScheduleEntryButton = document.getElementById('addScheduleEntryButton');
        const scheduleModal = document.getElementById('scheduleModal');
        const scheduleModalTitle = document.getElementById('scheduleModalTitle');
        const scheduleDayInput = document.getElementById('scheduleDayInput');
        const scheduleTimeInput = document.getElementById('scheduleTimeInput');
        const scheduleSubjectInput = document.getElementById('scheduleSubjectInput');
        const scheduleWeekTypeInput = document.getElementById('scheduleWeekTypeInput');
        const saveScheduleEntryButton = document.getElementById('saveScheduleEntryButton');
        const closeScheduleModalButton = document.getElementById('closeScheduleModalButton');
        
        // Element for the "Show Code" button and code display
        const showCodeButton = document.getElementById('showCodeButton');
        const codeDisplay = document.getElementById('codeDisplay');


        // --- TELEGRAM WEB APP INTEGRATION ---
        const WebApp = window.Telegram.WebApp;

        WebApp.ready(); // Сообщить Telegram, что приложение готово к использованию.
        WebApp.onEvent('backButtonClicked', goBack);

        // --- CORE FUNCTIONS ---
        function showPage(pageId) {
            pages.forEach(page => page.classList.remove('active'));
            document.getElementById(pageId).classList.add('active');
            
            // Manage history to enable back navigation
            if (pageHistory[pageHistory.length - 1] !== pageId) {
                pageHistory.push(pageId);
            }
            
            updateNavigationUI();
            
            // Render specific content for each page
            if (pageId === 'faculties_page') {
                renderFaculties();
            } else if (pageId === 'groups_page') {
                renderGroups();
            } else if (pageId === 'schedule_page') {
                renderSchedule();
            } else if (pageId === 'schedule_admin_page') {
                renderGroupSelect();
                renderScheduleAdminList();
            } else if (pageId === 'admin_page') {
                pageHistory.splice(1); // Clear history after admin page
            }
        }

        function goBack() {
            if (pageHistory.length > 1) {
                pageHistory.pop();
                const lastPageId = pageHistory[pageHistory.length - 1];
                pages.forEach(page => page.classList.remove('active'));
                document.getElementById(lastPageId).classList.add('active');
                updateNavigationUI();
                
                // Re-render content when going back
                if (lastPageId === 'faculties_page') {
                    renderFaculties();
                } else if (lastPageId === 'groups_page') {
                    renderGroups();
                } else if (lastPageId === 'schedule_page') {
                    renderSchedule();
                } else if (lastPageId === 'admin_page') {
                    // This case is handled by `homeButton` now, but keeping for completeness
                }
            } else {
                WebApp.close();
            }
        }

        function updateNavigationUI() {
            const currentPage = pageHistory[pageHistory.length - 1];
            
            // Show/hide Back button based on history length
            if (pageHistory.length > 1) {
                WebApp.BackButton.show();
                backButton.classList.remove('hidden');
            } else {
                WebApp.BackButton.hide();
                backButton.classList.add('hidden');
            }

            // Show/hide Home button for admin sections
            if (currentPage.includes('_page') && currentPage !== 'admin_page') {
                 if (isUserAdmin()) { // Check if user is authenticated as admin
                    homeButton.classList.remove('hidden');
                 } else {
                    homeButton.classList.add('hidden');
                 }
            } else {
                homeButton.classList.add('hidden');
            }

            // Show/hide Admin button on main page
            if (currentPage === 'schedule_page') {
                showAdminButton.classList.remove('hidden');
            } else {
                showAdminButton.classList.add('hidden');
            }

            // Set page title
            switch (currentPage) {
                case 'schedule_page':
                    pageTitle.textContent = 'Расписание';
                    break;
                case 'password_page':
                    pageTitle.textContent = 'Вход';
                    break;
                case 'admin_page':
                    pageTitle.textContent = 'Администрирование';
                    break;
                case 'faculties_page':
                    pageTitle.textContent = 'Факультеты';
                    break;
                case 'groups_page':
                    pageTitle.textContent = 'Группы';
                    break;
                case 'schedule_admin_page':
                    pageTitle.textContent = 'Редактирование расписания';
                    break;
                case 'faculty_edit_page':
                    pageTitle.textContent = 'Редактирование факультета';
                    break;
                case 'group_edit_page':
                    pageTitle.textContent = 'Редактирование группы';
                    break;
                case 'code_viewer_page':
                    pageTitle.textContent = 'Исходный код';
                    break;
                default:
                    pageTitle.textContent = 'Страница';
            }
        }
        
        // A simple check to see if the user has successfully logged in as admin
        function isUserAdmin() {
            return document.getElementById('admin_page').classList.contains('active') ||
                   pageHistory.includes('admin_page');
        }

        function showMessage(message, type) {
            messageBox.textContent = message;
            messageBox.classList.remove('opacity-0', 'bg-red-200', 'text-red-800', 'bg-green-200', 'text-green-800', 'bg-blue-200', 'text-blue-800');
            if (type === 'success') {
                messageBox.classList.add('bg-green-200', 'text-green-800');
            } else if (type === 'error') {
                messageBox.classList.add('bg-red-200', 'text-red-800');
            } else {
                messageBox.classList.add('bg-blue-200', 'text-blue-800');
            }
            messageBox.classList.add('opacity-100');
            setTimeout(() => {
                messageBox.classList.remove('opacity-100');
                messageBox.classList.add('opacity-0');
            }, 3000);
        }

        // --- RENDERING FUNCTIONS ---

        function renderFaculties() {
            facultiesList.innerHTML = '';
            faculties.forEach(faculty => {
                const facultyGroupsCount = groups.filter(g => g.facultyId === faculty.id).length;
                const item = document.createElement('div');
                item.className = 'flex items-center justify-between bg-gray-50 p-4 rounded-xl shadow-sm';
                item.innerHTML = `
                    <div>
                        <h3 class="font-semibold text-gray-900">${faculty.name}</h3>
                        <p class="text-sm text-gray-500">${facultyGroupsCount} групп(а)</p>
                    </div>
                    <div>
                        <button class="edit-btn text-blue-500 hover:text-blue-700 font-medium transition-colors duration-200 mr-2" data-id="${faculty.id}">Редактировать</button>
                        <button class="delete-btn text-red-500 hover:text-red-700 font-medium transition-colors duration-200" data-id="${faculty.id}">Удалить</button>
                    </div>
                `;
                facultiesList.appendChild(item);
            });
        }

        function renderGroups() {
            groupsList.innerHTML = '';
            groups.forEach(group => {
                const faculty = faculties.find(f => f.id === group.facultyId);
                const facultyName = faculty ? faculty.name : 'Без факультета';
                const item = document.createElement('div');
                item.className = 'flex items-center justify-between bg-gray-50 p-4 rounded-xl shadow-sm';
                item.innerHTML = `
                    <div>
                        <h3 class="font-semibold text-gray-900">${group.name}</h3>
                        <p class="text-sm text-gray-500">${facultyName}</p>
                    </div>
                    <div>
                        <button class="edit-btn text-blue-500 hover:text-blue-700 font-medium transition-colors duration-200 mr-2" data-id="${group.id}">Редактировать</button>
                        <button class="delete-btn text-red-500 hover:text-red-700 font-medium transition-colors duration-200" data-id="${group.id}">Удалить</button>
                    </div>
                `;
                groupsList.appendChild(item);
            });
        }

        function renderFacultyGroups(facultyId) {
            facultyGroupsList.innerHTML = '';
            const facultyGroups = groups.filter(g => g.facultyId === facultyId);
            if (facultyGroups.length === 0) {
                facultyGroupsList.innerHTML = `<p class="text-gray-500 text-sm">В этом факультете пока нет групп.</p>`;
            }
            facultyGroups.forEach(group => {
                const item = document.createElement('div');
                item.className = 'flex items-center justify-between bg-white p-3 rounded-lg border border-gray-200';
                item.innerHTML = `
                    <span class="text-gray-800">${group.name}</span>
                    <button class="remove-group-btn text-red-500 hover:text-red-700 text-sm font-medium transition-colors duration-200" data-group-id="${group.id}">Убрать</button>
                `;
                facultyGroupsList.appendChild(item);
            });
        }

        function renderAvailableGroups() {
            availableGroupsList.innerHTML = '';
            const availableGroups = groups.filter(g => g.facultyId === null);
            if (availableGroups.length === 0) {
                availableGroupsList.innerHTML = `<p class="text-gray-500 text-sm">Все группы уже привязаны к факультетам.</p>`;
            }
            availableGroups.forEach(group => {
                const item = document.createElement('div');
                item.className = 'flex items-center justify-between bg-gray-50 p-3 rounded-lg border border-gray-200';
                item.innerHTML = `
                    <span class="text-gray-800">${group.name}</span>
                    <button class="add-group-btn bg-green-500 text-white text-sm font-medium py-1 px-3 rounded-lg hover:bg-green-600 transition-colors duration-200" data-group-id="${group.id}">Добавить</button>
                `;
                availableGroupsList.appendChild(item);
            });
        }

        function renderSchedule() {
            scheduleList.innerHTML = '';
            const selectedFacultyId = facultyFilter.value === 'all' ? null : parseInt(facultyFilter.value);
            const selectedGroupId = groupFilter.value === 'all' ? null : parseInt(groupFilter.value);
            const dayFilterValue = dayFilter.value;
            const weekTypeFilterValue = weekTypeFilter.value;
            const daysOfWeek = ['Воскресенье', 'Понедельник', 'Вторник', 'Среда', 'Четверг', 'Пятница', 'Суббота'];
            
            // Check if both faculty and group are selected
            if (!selectedFacultyId || !selectedGroupId) {
                scheduleList.innerHTML = `<p class="text-gray-500 text-center text-sm">Пожалуйста, выберите факультет и группу для просмотра расписания.</p>`;
                return;
            }

            const selectedGroup = groups.find(g => g.id === selectedGroupId);
            let filteredSchedule = [];

            if (selectedGroup) {
                filteredSchedule = schedule.filter(item => item.group === selectedGroup.name);
            }

            // Apply day filter
            if (dayFilterValue === 'today') {
                const today = new Date().getDay(); // 0 for Sunday, 1 for Monday, etc.
                const todayName = daysOfWeek[today];
                filteredSchedule = filteredSchedule.filter(item => item.day === todayName);
            }

            // Apply week type filter
            if (weekTypeFilterValue !== 'all') {
                filteredSchedule = filteredSchedule.filter(item => item.weekType === weekTypeFilterValue || item.weekType === 'all');
            }

            // Sort by day of week and then by time
            filteredSchedule.sort((a, b) => {
                const dayA = daysOfWeek.indexOf(a.day);
                const dayB = daysOfWeek.indexOf(b.day);
                if (dayA !== dayB) {
                    return dayA - dayB;
                }
                // Sort by time
                return a.time.localeCompare(b.time);
            });

            if (filteredSchedule.length === 0) {
                scheduleList.innerHTML = `<p class="text-gray-500 text-center text-sm">Занятий не найдено.</p>`;
                return;
            }
            
            const renderedDays = new Set();
            
            filteredSchedule.forEach(item => {
                if (!renderedDays.has(item.day)) {
                    const dayHeader = document.createElement('h3');
                    dayHeader.className = 'text-xl font-semibold text-gray-800 border-b-2 border-gray-200 pb-2 mb-2 mt-4';
                    dayHeader.textContent = item.day;
                    scheduleList.appendChild(dayHeader);
                    renderedDays.add(item.day);
                }

                const scheduleItem = document.createElement('div');
                scheduleItem.className = 'bg-gray-50 p-4 rounded-xl shadow-sm flex items-center justify-between';
                
                let weekBadgeClass = '';
                let weekBadgeText = '';
                if (item.weekType === 'all') {
                    weekBadgeClass = 'all';
                    weekBadgeText = 'Любая неделя';
                } else if (item.weekType === 'odd') {
                    weekBadgeClass = 'odd';
                    weekBadgeText = 'Нечетная неделя';
                } else if (item.weekType === 'even') {
                    weekBadgeClass = 'even';
                    weekBadgeText = 'Четная неделя';
                }

                scheduleItem.innerHTML = `
                    <div>
                        <div class="flex items-center space-x-2 mb-1">
                            <p class="font-bold text-lg text-gray-900">${item.subject}</p>
                            <span class="week-badge ${weekBadgeClass}">${weekBadgeText}</span>
                        </div>
                        <p class="text-sm text-gray-500">${item.time}</p>
                    </div>
                `;
                scheduleList.appendChild(scheduleItem);
            });
        }
        
        function renderScheduleAdminList() {
            scheduleAdminList.innerHTML = '';
            const selectedGroupId = groupSelect.value === 'all' ? null : parseInt(groupSelect.value);

            if (!selectedGroupId) {
                scheduleAdminList.innerHTML = `<p class="text-gray-500 text-center text-sm">Пожалуйста, выберите группу для редактирования расписания.</p>`;
                return;
            }

            const selectedGroup = groups.find(g => g.id === selectedGroupId);
            let filteredSchedule = [];
            if (selectedGroup) {
                 filteredSchedule = schedule.filter(item => item.group === selectedGroup.name);
            }
            
            const daysOfWeek = ['Понедельник', 'Вторник', 'Среда', 'Четверг', 'Пятница', 'Суббота', 'Воскресенье'];
            // Sort by day and then by time
            filteredSchedule.sort((a, b) => {
                const dayA = daysOfWeek.indexOf(a.day);
                const dayB = daysOfWeek.indexOf(b.day);
                if (dayA !== dayB) {
                    return dayA - dayB;
                }
                // Sort by time
                return a.time.localeCompare(b.time);
            });

            if (filteredSchedule.length === 0) {
                scheduleAdminList.innerHTML = `<p class="text-gray-500 text-center text-sm">У этой группы нет занятий. Нажмите +, чтобы добавить.</p>`;
                return;
            }

            const renderedDays = new Set();
            filteredSchedule.forEach(item => {
                if (!renderedDays.has(item.day)) {
                    const dayHeader = document.createElement('h3');
                    dayHeader.className = 'text-xl font-semibold text-gray-800 border-b-2 border-gray-200 pb-2 mb-2 mt-4';
                    dayHeader.textContent = item.day;
                    scheduleAdminList.appendChild(dayHeader);
                    renderedDays.add(item.day);
                }

                const scheduleItem = document.createElement('div');
                scheduleItem.className = 'bg-gray-50 p-4 rounded-xl shadow-sm flex items-center justify-between';
                
                let weekBadgeClass = '';
                let weekBadgeText = '';
                if (item.weekType === 'all') {
                    weekBadgeClass = 'all';
                    weekBadgeText = 'Любая неделя';
                } else if (item.weekType === 'odd') {
                    weekBadgeClass = 'odd';
                    weekBadgeText = 'Нечетная неделя';
                } else if (item.weekType === 'even') {
                    weekBadgeClass = 'even';
                    weekBadgeText = 'Четная неделя';
                }

                scheduleItem.innerHTML = `
                    <div>
                        <div class="flex items-center space-x-2 mb-1">
                            <p class="font-bold text-lg text-gray-900">${item.subject}</p>
                            <span class="week-badge ${weekBadgeClass}">${weekBadgeText}</span>
                        </div>
                        <p class="text-sm text-gray-500">${item.time}</p>
                    </div>
                    <div>
                        <button class="edit-schedule-btn text-blue-500 hover:text-blue-700 font-medium transition-colors duration-200 mr-2" data-id="${item.id}">Редактировать</button>
                        <button class="delete-schedule-btn text-red-500 hover:text-red-700 font-medium transition-colors duration-200" data-id="${item.id}">Удалить</button>
                    </div>
                `;
                scheduleAdminList.appendChild(scheduleItem);
            });
        }

        // Filter functions
        function renderFacultyFilter() {
            facultyFilter.innerHTML = '<option value="all">Все факультеты</option>';
            faculties.forEach(faculty => {
                const option = document.createElement('option');
                option.value = faculty.id;
                option.textContent = faculty.name;
                facultyFilter.appendChild(option);
            });
        }

        function renderGroupFilter() {
            groupFilter.innerHTML = '<option value="all">Все группы</option>';
            const selectedFacultyId = facultyFilter.value === 'all' ? null : parseInt(facultyFilter.value);
            
            const filteredGroups = selectedFacultyId ? 
                groups.filter(g => g.facultyId === selectedFacultyId) : 
                groups;

            filteredGroups.forEach(group => {
                const option = document.createElement('option');
                option.value = group.id;
                option.textContent = group.name;
                groupFilter.appendChild(option);
            });
        }

        function renderGroupSelect() {
            groupSelect.innerHTML = '<option value="all">Выберите группу</option>';
            groups.forEach(group => {
                const option = document.createElement('option');
                option.value = group.id;
                option.textContent = group.name;
                groupSelect.appendChild(option);
            });
        }

        // --- EVENT HANDLERS ---
        showAdminButton.addEventListener('click', () => {
            adminPasswordInput.value = ''; // Clear the input field
            showMessage('Для входа введите пароль.', 'info');
            showPage('password_page');
        });
        
        document.getElementById('submitPasswordButton').addEventListener('click', () => {
            const password = adminPasswordInput.value;
            if (password === ADMIN_PASSWORD) {
                showMessage('Успешный вход!', 'success');
                showPage('admin_page');
            } else {
                showMessage('Неверный пароль.', 'error');
            }
        });

        backButton.addEventListener('click', goBack);
        homeButton.addEventListener('click', () => showPage('admin_page')); // NEW
        document.getElementById('showFacultiesButton').addEventListener('click', () => showPage('faculties_page'));
        document.getElementById('showGroupsButton').addEventListener('click', () => showPage('groups_page'));
        document.getElementById('showScheduleAdminButton').addEventListener('click', () => showPage('schedule_admin_page'));

        // NEW: Event listener for the "Show Code" button to display the code as JSON
        showCodeButton.addEventListener('click', () => {
            const scheduleJson = JSON.stringify(schedule, null, 2);
            codeDisplay.textContent = scheduleJson;
            showPage('code_viewer_page');
        });
        
        // Schedule filter events
        facultyFilter.addEventListener('change', () => {
            renderGroupFilter();
            renderSchedule();
        });
        groupFilter.addEventListener('change', () => {
            renderSchedule();
        });
        dayFilter.addEventListener('change', () => {
            renderSchedule();
        });
        weekTypeFilter.addEventListener('change', () => {
            renderSchedule();
        });

        // Schedule Admin events
        groupSelect.addEventListener('change', () => {
            renderScheduleAdminList();
        });

        addScheduleEntryButton.addEventListener('click', () => {
            if (groupSelect.value === 'all') {
                showMessage('Пожалуйста, сначала выберите группу.', 'error');
                return;
            }
            // Reset modal for new entry
            currentScheduleEntryId = null;
            scheduleModalTitle.textContent = 'Добавить занятие';
            scheduleDayInput.value = 'Понедельник';
            scheduleTimeInput.value = '';
            scheduleSubjectInput.value = '';
            scheduleWeekTypeInput.value = 'all';
            scheduleModal.classList.remove('hidden');
        });
        
        saveScheduleEntryButton.addEventListener('click', () => {
            const groupId = parseInt(groupSelect.value);
            const selectedGroup = groups.find(g => g.id === groupId);
            const day = scheduleDayInput.value;
            const time = scheduleTimeInput.value;
            const subject = scheduleSubjectInput.value.trim();
            const weekType = scheduleWeekTypeInput.value;

            if (!time || !subject) {
                showMessage('Пожалуйста, заполните все поля.', 'error');
                return;
            }

            if (currentScheduleEntryId) {
                const entry = schedule.find(e => e.id === currentScheduleEntryId);
                if (entry) {
                    entry.day = day;
                    entry.time = time;
                    entry.subject = subject;
                    entry.weekType = weekType;
                    showMessage('Занятие успешно обновлено!', 'success');
                }
            } else {
                const newId = schedule.length > 0 ? Math.max(...schedule.map(e => e.id)) + 1 : 1;
                schedule.push({ id: newId, day: day, time: time, subject: subject, group: selectedGroup.name, weekType: weekType });
                showMessage('Занятие успешно добавлено!', 'success');
            }

            scheduleModal.classList.add('hidden');
            renderScheduleAdminList();
            renderSchedule(); // Update the main schedule view
        });

        closeScheduleModalButton.addEventListener('click', () => {
            scheduleModal.classList.add('hidden');
        });
        
        scheduleAdminList.addEventListener('click', (e) => {
            const btn = e.target;
            const id = parseInt(btn.dataset.id);

            if (btn.classList.contains('edit-schedule-btn')) {
                currentScheduleEntryId = id;
                const entry = schedule.find(e => e.id === id);
                if (entry) {
                    scheduleModalTitle.textContent = 'Редактировать занятие';
                    scheduleDayInput.value = entry.day;
                    scheduleTimeInput.value = entry.time;
                    scheduleSubjectInput.value = entry.subject;
                    scheduleWeekTypeInput.value = entry.weekType;
                    scheduleModal.classList.remove('hidden');
                }
            } else if (btn.classList.contains('delete-schedule-btn')) {
                // Using WebApp.showConfirm as a non-blocking alternative to window.confirm()
                WebApp.showConfirm('Вы уверены, что хотите удалить это занятие?', (isConfirmed) => {
                    if (isConfirmed) {
                        schedule = schedule.filter(e => e.id !== id);
                        showMessage('Занятие удалено.', 'success');
                        renderScheduleAdminList();
                        renderSchedule(); // Update the main schedule view
                    }
                });
            }
        });

        // Faculty actions
        document.getElementById('addFacultyButton').addEventListener('click', () => {
            currentFacultyId = null;
            document.getElementById('facultyFormTitle').textContent = 'Создание нового факультета';
            facultyNameInput.value = '';
            facultyGroupsSection.classList.add('hidden');
            showPage('faculty_edit_page');
        });
        document.getElementById('saveFacultyButton').addEventListener('click', () => {
            const name = facultyNameInput.value.trim();
            if (name) {
                if (currentFacultyId) {
                    const faculty = faculties.find(f => f.id === currentFacultyId);
                    if (faculty) {
                        faculty.name = name;
                        showMessage('Факультет успешно обновлен!', 'success');
                    }
                } else {
                    const newId = faculties.length > 0 ? Math.max(...faculties.map(f => f.id)) + 1 : 1;
                    faculties.push({ id: newId, name: name });
                    showMessage('Факультет успешно создан!', 'success');
                }
                renderFacultyFilter();
                showPage('faculties_page');
            } else {
                showMessage('Пожалуйста, введите название.', 'error');
            }
        });
        facultiesList.addEventListener('click', (e) => {
            const btn = e.target;
            const id = parseInt(btn.dataset.id);
            if (btn.classList.contains('edit-btn')) {
                currentFacultyId = id;
                const faculty = faculties.find(f => f.id === id);
                document.getElementById('facultyFormTitle').textContent = 'Редактирование факультета';
                facultyNameInput.value = faculty.name;
                facultyGroupsSection.classList.remove('hidden');
                renderFacultyGroups(id);
                showPage('faculty_edit_page');
            } else if (btn.classList.contains('delete-btn')) {
                WebApp.showConfirm('Вы уверены, что хотите удалить этот факультет?', (isConfirmed) => {
                    if (isConfirmed) {
                        groups.forEach(group => {
                            if (group.facultyId === id) {
                                group.facultyId = null;
                            }
                        });
                        faculties = faculties.filter(f => f.id !== id);
                        renderFaculties();
                        renderFacultyFilter();
                        renderGroupFilter();
                        renderSchedule();
                        showMessage('Факультет успешно удален.', 'success');
                    }
                });
            }
        });
        
        // Group actions
        document.getElementById('addGroupButton').addEventListener('click', () => {
            currentGroupId = null;
            document.getElementById('groupFormTitle').textContent = 'Создание новой группы';
            groupNameInput.value = '';
            showPage('group_edit_page');
        });
        document.getElementById('saveGroupButton').addEventListener('click', () => {
            const name = groupNameInput.value.trim();
            if (name) {
                if (currentGroupId) {
                    const group = groups.find(g => g.id === currentGroupId);
                    if (group) {
                        group.name = name;
                        showMessage('Группа успешно обновлена!', 'success');
                    }
                } else {
                    const newId = groups.length > 0 ? Math.max(...groups.map(g => g.id)) + 1 : 101;
                    groups.push({ id: newId, name: name, facultyId: null });
                    showMessage('Группа успешно создана!', 'success');
                }
                renderGroupFilter();
                renderSchedule();
                showPage('groups_page');
            } else {
                showMessage('Пожалуйста, введите название.', 'error');
            }
        });
        groupsList.addEventListener('click', (e) => {
            const btn = e.target;
            const id = parseInt(btn.dataset.id);
            if (btn.classList.contains('edit-btn')) {
                currentGroupId = id;
                const group = groups.find(g => g.id === id);
                document.getElementById('groupFormTitle').textContent = 'Редактирование группы';
                groupNameInput.value = group.name;
                showPage('group_edit_page');
            } else if (btn.classList.contains('delete-btn')) {
                WebApp.showConfirm('Вы уверены, что хотите удалить эту группу?', (isConfirmed) => {
                    if (isConfirmed) {
                        groups = groups.filter(g => g.id !== id);
                        renderGroups();
                        renderGroupFilter();
                        renderSchedule();
                        showMessage('Группа успешно удалена.', 'success');
                    }
                });
            }
        });

        // Add/Remove Groups from Faculty
        document.getElementById('addGroupsToFacultyButton').addEventListener('click', () => {
            renderAvailableGroups();
            addGroupsModal.classList.remove('hidden');
        });

        document.getElementById('closeModalButton').addEventListener('click', () => {
            addGroupsModal.classList.add('hidden');
        });
        
        availableGroupsList.addEventListener('click', (e) => {
            const btn = e.target;
            if (btn.classList.contains('add-group-btn')) {
                const groupId = parseInt(btn.dataset.groupId);
                const group = groups.find(g => g.id === groupId);
                if (group) {
                    group.facultyId = currentFacultyId;
                    showMessage(`Группа "${group.name}" добавлена в факультет.`, 'success');
                    renderFacultyGroups(currentFacultyId);
                    addGroupsModal.classList.add('hidden');
                    renderFacultyFilter();
                    renderGroupFilter();
                    renderSchedule();
                }
            }
        });

        facultyGroupsList.addEventListener('click', (e) => {
            const btn = e.target;
            if (btn.classList.contains('remove-group-btn')) {
                const groupId = parseInt(btn.dataset.groupId);
                const group = groups.find(g => g.id === groupId);
                if (group) {
                    group.facultyId = null;
                    showMessage(`Группа "${group.name}" удалена из факультета.`, 'success');
                    renderFacultyGroups(currentFacultyId);
                    renderFacultyFilter();
                    renderGroupFilter();
                    renderSchedule();
                }
            }
        });

        // Initial rendering on page load
        document.addEventListener('DOMContentLoaded', () => {
            renderFacultyFilter();
            renderGroupFilter();
            renderSchedule();
            updateNavigationUI();
        });
        
    </script>
</body>
</html>
