<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Управление Факультетами и Группами</title>
    <!-- Telegram Web App script is essential for mini-apps -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .page {
            display: none;
        }
        .page.active {
            display: block;
        }
        /* Style for the week type badge */
        .week-badge {
            font-size: 0.75rem;
            padding: 0.25rem 0.5rem;
            border-radius: 9999px;
            font-weight: 500;
            white-space: nowrap;
        }
        .week-badge.all {
            background-color: #d1d5db; /* gray-300 */
            color: #4b5563; /* gray-600 */
        }
        .week-badge.odd {
            background-color: #fca5a5; /* red-300 */
            color: #991b1b; /* red-800 */
        }
        .week-badge.even {
            background-color: #a5f3fc; /* cyan-300 */
            color: #0891b2; /* cyan-700 */
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen p-4 flex flex-col items-center">

    <!-- Main Container -->
    <div class="bg-white p-6 md:p-10 rounded-3xl shadow-2xl w-full max-w-2xl">
        
        <!-- Header with Title and Buttons -->
        <div class="flex justify-between items-center mb-6 border-b pb-4">
            <button id="backButton" class="text-gray-500 hover:text-gray-700 transition-colors duration-200 p-2 rounded-full hidden">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
                </svg>
            </button>
            <h1 id="pageTitle" class="text-3xl font-bold text-gray-900">Расписание</h1>
            <button id="showAdminButton" class="text-gray-500 hover:text-gray-700 transition-colors duration-200 p-2 rounded-full">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.527.272 1.092.427 1.724 1.066z" />
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                </svg>
            </button>
        </div>

        <!-- User ID display -->
        <div id="userIdDisplay" class="mb-4 text-center text-sm text-gray-500"></div>

        <!-- Pages Container -->
        <div id="pagesContainer">
            
            <!-- Schedule Page (Now the default page) -->
            <div id="schedule_page" class="page active">
                <div class="mb-4 space-y-4">
                    <div class="space-y-2">
                        <label for="facultyFilter" class="block text-sm font-medium text-gray-700">Факультет:</label>
                        <select id="facultyFilter" class="w-full p-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-purple-500">
                            <!-- Options populated by JS -->
                        </select>
                    </div>
                    <div class="space-y-2">
                        <label for="groupFilter" class="block text-sm font-medium text-gray-700">Группа:</label>
                        <select id="groupFilter" class="w-full p-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-purple-500">
                            <!-- Options populated by JS -->
                        </select>
                    </div>
                    <div class="space-y-2">
                        <label for="dayFilter" class="block text-sm font-medium text-gray-700">День:</label>
                        <select id="dayFilter" class="w-full p-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-purple-500">
                            <option value="all">Вся неделя</option>
                            <option value="today">Сегодня</option>
                        </select>
                    </div>
                    <div class="space-y-2">
                        <label for="weekTypeFilter" class="block text-sm font-medium text-gray-700">Тип недели:</label>
                        <select id="weekTypeFilter" class="w-full p-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-purple-500">
                            <option value="all">Все</option>
                            <option value="even">Четная</option>
                            <option value="odd">Нечетная</option>
                        </select>
                    </div>
                </div>
                <div id="scheduleList" class="space-y-6">
                    <!-- Schedule items will be rendered here -->
                </div>
            </div>

            <!-- Admin Home Page (password check is now done by Firebase) -->
            <div id="admin_page" class="page">
                <p class="text-gray-600 mb-6">Панель администрирования. Здесь вы можете управлять данными.</p>
                <div class="space-y-4">
                    <button id="showFacultiesButton" class="w-full bg-blue-600 text-white font-semibold py-3 px-6 rounded-xl hover:bg-blue-700 transition-colors duration-200 shadow-md">
                        Управление факультетами
                    </button>
                    <button id="showGroupsButton" class="w-full bg-green-600 text-white font-semibold py-3 px-6 rounded-xl hover:bg-green-700 transition-colors duration-200 shadow-md">
                        Управление группами
                    </button>
                    <button id="showScheduleAdminButton" class="w-full bg-indigo-600 text-white font-semibold py-3 px-6 rounded-xl hover:bg-indigo-700 transition-colors duration-200 shadow-md">
                        Управление расписанием
                    </button>
                </div>
            </div>

            <!-- Schedule Admin Page -->
            <div id="schedule_admin_page" class="page">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-semibold text-gray-800">Редактирование расписания</h2>
                    <button id="addScheduleEntryButton" class="bg-blue-500 text-white p-2 rounded-full hover:bg-blue-600 transition-colors duration-200 shadow-md">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
                        </svg>
                    </button>
                </div>
                <div class="space-y-2 mb-4">
                    <label for="groupSelect" class="block text-sm font-medium text-gray-700">Выберите группу:</label>
                    <select id="groupSelect" class="w-full p-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-purple-500">
                        <!-- Options populated by JS -->
                    </select>
                </div>
                <div id="scheduleAdminList" class="space-y-6">
                    <!-- Schedule items will be rendered here -->
                </div>
            </div>

            <!-- Faculties List Page -->
            <div id="faculties_page" class="page">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-semibold text-gray-800">Список факультетов</h2>
                    <button id="addFacultyButton" class="bg-blue-500 text-white p-2 rounded-full hover:bg-blue-600 transition-colors duration-200 shadow-md">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
                        </svg>
                    </button>
                </div>
                <div id="facultiesList" class="space-y-4">
                    <!-- Faculty items will be rendered here -->
                </div>
            </div>

            <!-- Groups List Page -->
            <div id="groups_page" class="page">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-semibold text-gray-800">Список групп</h2>
                    <button id="addGroupButton" class="bg-blue-500 text-white p-2 rounded-full hover:bg-blue-600 transition-colors duration-200 shadow-md">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
                        </svg>
                    </button>
                </div>
                <div id="groupsList" class="space-y-4">
                    <!-- Group items will be rendered here -->
                </div>
            </div>

            <!-- Faculty Edit/Create Page -->
            <div id="faculty_edit_page" class="page">
                <h2 id="facultyFormTitle" class="text-2xl font-semibold text-gray-800 mb-4"></h2>
                <input id="facultyNameInput" type="text" placeholder="Название факультета" class="w-full p-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-blue-500 mb-4">
                <button id="saveFacultyButton" class="w-full bg-blue-600 text-white font-semibold py-3 px-6 rounded-xl hover:bg-blue-700 transition-colors duration-200 shadow-md">
                    Сохранить
                </button>

                <div id="facultyGroupsSection" class="mt-8 pt-4 border-t border-gray-200 hidden">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xl font-semibold text-gray-800">Группы факультета</h3>
                        <button id="addGroupsToFacultyButton" class="bg-green-500 text-white p-2 rounded-full hover:bg-green-600 transition-colors duration-200 shadow-md">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
                            </svg>
                        </button>
                    </div>
                    <div id="facultyGroupsList" class="space-y-2">
                        <!-- Groups in this faculty will be rendered here -->
                    </div>
                </div>
            </div>

            <!-- Group Edit/Create Page -->
            <div id="group_edit_page" class="page">
                <h2 id="groupFormTitle" class="text-2xl font-semibold text-gray-800 mb-4"></h2>
                <input id="groupNameInput" type="text" placeholder="Название группы" class="w-full p-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-blue-500 mb-4">
                <button id="saveGroupButton" class="w-full bg-blue-600 text-white font-semibold py-3 px-6 rounded-xl hover:bg-blue-700 transition-colors duration-200 shadow-md">
                    Сохранить
                </button>
            </div>
            
            <!-- Modal for adding groups to faculty -->
            <div id="addGroupsModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden">
                <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-xl bg-white">
                    <div class="mt-3 text-center">
                        <h3 class="text-lg leading-6 font-medium text-gray-900">Добавить группы</h3>
                        <div class="mt-2 px-7 py-3">
                            <div id="availableGroupsList" class="space-y-2">
                                <!-- Available groups will be rendered here -->
                            </div>
                        </div>
                        <div class="items-center px-4 py-3">
                            <button id="closeModalButton" class="px-4 py-2 bg-gray-200 text-gray-700 text-base font-medium rounded-xl hover:bg-gray-300 transition-colors duration-200 w-full">
                                Закрыть
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Modal for adding/editing schedule entry -->
            <div id="scheduleModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden">
                <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-xl bg-white">
                    <div class="mt-3 text-center">
                        <h3 id="scheduleModalTitle" class="text-lg leading-6 font-medium text-gray-900">Добавить занятие</h3>
                        <div class="mt-2 px-7 py-3 space-y-4">
                            <select id="scheduleDayInput" class="w-full p-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-purple-500">
                                <option value="Понедельник">Понедельник</option>
                                <option value="Вторник">Вторник</option>
                                <option value="Среда">Среда</option>
                                <option value="Четверг">Четверг</option>
                                <option value="Пятница">Пятница</option>
                                <option value="Суббота">Суббота</option>
                                <option value="Воскресенье">Воскресенье</option>
                            </select>
                            <input id="scheduleTimeInput" type="time" class="w-full p-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-blue-500">
                            <input id="scheduleSubjectInput" type="text" placeholder="Название предмета" class="w-full p-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-blue-500">
                            <select id="scheduleWeekTypeInput" class="w-full p-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-purple-500">
                                <option value="all">Для всех недель</option>
                                <option value="even">Четная неделя</option>
                                <option value="odd">Нечетная неделя</option>
                            </select>
                        </div>
                        <div class="items-center px-4 py-3">
                            <button id="saveScheduleEntryButton" class="px-4 py-2 bg-blue-600 text-white text-base font-medium rounded-xl hover:bg-blue-700 transition-colors duration-200 w-full mb-2">
                                Сохранить
                            </button>
                            <button id="closeScheduleModalButton" class="px-4 py-2 bg-gray-200 text-gray-700 text-base font-medium rounded-xl hover:bg-gray-300 transition-colors duration-200 w-full">
                                Отмена
                            </button>
                        </div>
                    </div>
                </div>
            </div>

        </div>

        <!-- Status Message Box -->
        <div id="messageBox" class="mt-8 p-4 rounded-xl text-center font-medium transition-opacity duration-300 opacity-0"></div>

    </div>

    <script type="module">
        // Import necessary Firebase libraries
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global variables provided by the Canvas environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = {
        apiKey: "AIzaSyB2kuT1fSPp4kBKeEad_rYXMqh27z2KDO0",
        authDomain: "raspisanie-c90b6.firebaseapp.com",
        projectId: "raspisanie-c90b6",
        storageBucket: "raspisanie-c90b6.firebasestorage.app",
        messagingSenderId: "867699750609",
        appId: "1:867699750609:web:6cbf1c0c8bfa429b0337f0",
        measurementId: "G-JDF8DNGFZT"
        };
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // --- DATA AND STATE MANAGEMENT ---
        let faculties = [];
        let groups = [];
        let schedule = [];
        let userId = null;
        let isAuthReady = false;

        let currentFacultyId = null;
        let currentGroupId = null;
        let currentScheduleEntryId = null;

        // --- NAVIGATION STATE ---
        const pageHistory = ['schedule_page'];
        const pageTitle = document.getElementById('pageTitle');
        
        // --- DOM ELEMENTS ---
        const pages = document.querySelectorAll('.page');
        const showAdminButton = document.getElementById('showAdminButton');
        const backButton = document.getElementById('backButton');
        const facultiesList = document.getElementById('facultiesList');
        const groupsList = document.getElementById('groupsList');
        const scheduleList = document.getElementById('scheduleList');
        const facultyFilter = document.getElementById('facultyFilter');
        const groupFilter = document.getElementById('groupFilter');
        const dayFilter = document.getElementById('dayFilter');
        const weekTypeFilter = document.getElementById('weekTypeFilter');
        const facultyNameInput = document.getElementById('facultyNameInput');
        const groupNameInput = document.getElementById('groupNameInput');
        const facultyGroupsSection = document.getElementById('facultyGroupsSection');
        const facultyGroupsList = document.getElementById('facultyGroupsList');
        const addGroupsModal = document.getElementById('addGroupsModal');
        const availableGroupsList = document.getElementById('availableGroupsList');
        const messageBox = document.getElementById('messageBox');
        const userIdDisplay = document.getElementById('userIdDisplay');
        const showAdminPage = document.getElementById('admin_page');
        
        // Schedule admin elements
        const groupSelect = document.getElementById('groupSelect');
        const scheduleAdminList = document.getElementById('scheduleAdminList');
        const addScheduleEntryButton = document.getElementById('addScheduleEntryButton');
        const scheduleModal = document.getElementById('scheduleModal');
        const scheduleModalTitle = document.getElementById('scheduleModalTitle');
        const scheduleDayInput = document.getElementById('scheduleDayInput');
        const scheduleTimeInput = document.getElementById('scheduleTimeInput');
        const scheduleSubjectInput = document.getElementById('scheduleSubjectInput');
        const scheduleWeekTypeInput = document.getElementById('scheduleWeekTypeInput');
        const saveScheduleEntryButton = document.getElementById('saveScheduleEntryButton');
        const closeScheduleModalButton = document.getElementById('closeScheduleModalButton');

        // --- TELEGRAM WEB APP INTEGRATION ---
        const WebApp = window.Telegram.WebApp;
        WebApp.ready(); // Сообщить Telegram, что приложение готово к использованию.
        WebApp.onEvent('backButtonClicked', goBack);

        // --- CORE FUNCTIONS ---
        function showPage(pageId) {
            pages.forEach(page => page.classList.remove('active'));
            document.getElementById(pageId).classList.add('active');
            
            if (pageHistory[pageHistory.length - 1] !== pageId) {
                pageHistory.push(pageId);
            }
            
            updateNavigationUI();
        }

        function goBack() {
            if (pageHistory.length > 1) {
                pageHistory.pop();
                const lastPageId = pageHistory[pageHistory.length - 1];
                showPage(lastPageId);
            } else {
                WebApp.close();
            }
        }

        function updateNavigationUI() {
            if (pageHistory.length > 1) {
                WebApp.BackButton.show();
                showAdminButton.classList.add('hidden');
            } else {
                WebApp.BackButton.hide();
                showAdminButton.classList.remove('hidden');
            }

            const currentPage = pageHistory[pageHistory.length - 1];
            switch (currentPage) {
                case 'schedule_page':
                    pageTitle.textContent = 'Расписание';
                    break;
                case 'admin_page':
                    pageTitle.textContent = 'Администрирование';
                    break;
                case 'faculties_page':
                    pageTitle.textContent = 'Факультеты';
                    renderFaculties();
                    break;
                case 'groups_page':
                    pageTitle.textContent = 'Группы';
                    renderGroups();
                    break;
                case 'schedule_admin_page':
                    pageTitle.textContent = 'Редактирование расписания';
                    renderGroupSelect();
                    renderScheduleAdminList();
                    break;
                case 'faculty_edit_page':
                    pageTitle.textContent = 'Редактирование факультета';
                    break;
                case 'group_edit_page':
                    pageTitle.textContent = 'Редактирование группы';
                    break;
                default:
                    pageTitle.textContent = 'Страница';
            }
        }
        
        function showMessage(message, type) {
            messageBox.textContent = message;
            messageBox.classList.remove('opacity-0', 'bg-red-200', 'text-red-800', 'bg-green-200', 'text-green-800', 'bg-blue-200', 'text-blue-800');
            if (type === 'success') {
                messageBox.classList.add('bg-green-200', 'text-green-800');
            } else if (type === 'error') {
                messageBox.classList.add('bg-red-200', 'text-red-800');
            } else {
                messageBox.classList.add('bg-blue-200', 'text-blue-800');
            }
            messageBox.classList.add('opacity-100');
            setTimeout(() => {
                messageBox.classList.remove('opacity-100');
                messageBox.classList.add('opacity-0');
            }, 3000);
        }

        // --- FIREBASE INITIALIZATION AND REAL-TIME LISTENERS ---
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                userId = user.uid;
                userIdDisplay.textContent = `Ваш ID: ${userId}`;
                isAuthReady = true;

                // Start real-time listeners for all collections
                setupFirestoreListeners();
            } else {
                try {
                    if (initialAuthToken) {
                        await signInWithCustomToken(auth, initialAuthToken);
                    } else {
                        await signInAnonymously(auth);
                    }
                } catch (error) {
                    console.error("Firebase auth failed:", error);
                }
            }
        });

        function setupFirestoreListeners() {
            // Listen for real-time updates to the faculties collection
            onSnapshot(collection(db, `artifacts/${appId}/public/data/faculties`), (snapshot) => {
                faculties = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderFacultyFilters();
                // We re-render groups and schedules to reflect changes in faculties
                renderGroups();
                renderSchedule();
                renderFacultyGroups(currentFacultyId);
            });

            // Listen for real-time updates to the groups collection
            onSnapshot(collection(db, `artifacts/${appId}/public/data/groups`), (snapshot) => {
                groups = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderGroupFilters();
                // We re-render faculties and schedules to reflect changes in groups
                renderFaculties();
                renderSchedule();
                renderFacultyGroups(currentFacultyId);
                renderGroupSelect();
            });

            // Listen for real-time updates to the schedule collection
            onSnapshot(collection(db, `artifacts/${appId}/public/data/schedule`), (snapshot) => {
                schedule = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderSchedule();
                renderScheduleAdminList();
            });
        }

        // --- RENDERING FUNCTIONS ---

        function renderFaculties() {
            facultiesList.innerHTML = '';
            faculties.forEach(faculty => {
                const facultyGroupsCount = groups.filter(g => g.facultyId === faculty.id).length;
                const item = document.createElement('div');
                item.className = 'flex items-center justify-between bg-gray-50 p-4 rounded-xl shadow-sm';
                item.innerHTML = `
                    <div>
                        <h3 class="font-semibold text-gray-900">${faculty.name}</h3>
                        <p class="text-sm text-gray-500">${facultyGroupsCount} групп(а)</p>
                    </div>
                    <div>
                        <button class="edit-btn text-blue-500 hover:text-blue-700 font-medium transition-colors duration-200 mr-2" data-id="${faculty.id}">Редактировать</button>
                        <button class="delete-btn text-red-500 hover:text-red-700 font-medium transition-colors duration-200" data-id="${faculty.id}">Удалить</button>
                    </div>
                `;
                facultiesList.appendChild(item);
            });
        }

        function renderGroups() {
            groupsList.innerHTML = '';
            groups.forEach(group => {
                const faculty = faculties.find(f => f.id === group.facultyId);
                const facultyName = faculty ? faculty.name : 'Без факультета';
                const item = document.createElement('div');
                item.className = 'flex items-center justify-between bg-gray-50 p-4 rounded-xl shadow-sm';
                item.innerHTML = `
                    <div>
                        <h3 class="font-semibold text-gray-900">${group.name}</h3>
                        <p class="text-sm text-gray-500">${facultyName}</p>
                    </div>
                    <div>
                        <button class="edit-btn text-blue-500 hover:text-blue-700 font-medium transition-colors duration-200 mr-2" data-id="${group.id}">Редактировать</button>
                        <button class="delete-btn text-red-500 hover:text-red-700 font-medium transition-colors duration-200" data-id="${group.id}">Удалить</button>
                    </div>
                `;
                groupsList.appendChild(item);
            });
        }

        function renderFacultyGroups(facultyId) {
            facultyGroupsList.innerHTML = '';
            const facultyGroups = groups.filter(g => g.facultyId === facultyId);
            if (facultyGroups.length === 0) {
                facultyGroupsList.innerHTML = `<p class="text-gray-500 text-sm">В этом факультете пока нет групп.</p>`;
            }
            facultyGroups.forEach(group => {
                const item = document.createElement('div');
                item.className = 'flex items-center justify-between bg-white p-3 rounded-lg border border-gray-200';
                item.innerHTML = `
                    <span class="text-gray-800">${group.name}</span>
                    <button class="remove-group-btn text-red-500 hover:text-red-700 text-sm font-medium transition-colors duration-200" data-group-id="${group.id}">Убрать</button>
                `;
                facultyGroupsList.appendChild(item);
            });
        }

        function renderAvailableGroups() {
            availableGroupsList.innerHTML = '';
            const availableGroups = groups.filter(g => !g.facultyId);
            if (availableGroups.length === 0) {
                availableGroupsList.innerHTML = `<p class="text-gray-500 text-sm">Все группы уже привязаны к факультетам.</p>`;
            }
            availableGroups.forEach(group => {
                const item = document.createElement('div');
                item.className = 'flex items-center justify-between bg-gray-50 p-3 rounded-lg border border-gray-200';
                item.innerHTML = `
                    <span class="text-gray-800">${group.name}</span>
                    <button class="add-group-btn bg-green-500 text-white text-sm font-medium py-1 px-3 rounded-lg hover:bg-green-600 transition-colors duration-200" data-group-id="${group.id}">Добавить</button>
                `;
                availableGroupsList.appendChild(item);
            });
        }

        function renderFacultyFilters() {
            facultyFilter.innerHTML = '<option value="all">Выберите факультет</option>';
            faculties.forEach(faculty => {
                const option = document.createElement('option');
                option.value = faculty.id;
                option.textContent = faculty.name;
                facultyFilter.appendChild(option);
            });
        }

        function renderGroupFilters() {
            groupFilter.innerHTML = '<option value="all">Выберите группу</option>';
            const selectedFacultyId = facultyFilter.value === 'all' ? null : facultyFilter.value;
            const groupsInFaculty = selectedFacultyId ? groups.filter(g => g.facultyId === selectedFacultyId) : groups;
            groupsInFaculty.forEach(group => {
                const option = document.createElement('option');
                option.value = group.id;
                option.textContent = group.name;
                groupFilter.appendChild(option);
            });
        }

        function renderGroupSelect() {
            groupSelect.innerHTML = '<option value="">Выберите группу</option>';
            groups.forEach(group => {
                const option = document.createElement('option');
                option.value = group.id;
                option.textContent = group.name;
                groupSelect.appendChild(option);
            });
        }

        function renderSchedule() {
            scheduleList.innerHTML = '';
            const selectedFacultyId = facultyFilter.value === 'all' ? null : facultyFilter.value;
            const selectedGroupId = groupFilter.value === 'all' ? null : groupFilter.value;
            const dayFilterValue = dayFilter.value;
            const weekTypeFilterValue = weekTypeFilter.value;
            const daysOfWeek = ['Воскресенье', 'Понедельник', 'Вторник', 'Среда', 'Четверг', 'Пятница', 'Суббота'];
            
            if (!selectedFacultyId || !selectedGroupId) {
                scheduleList.innerHTML = `<p class="text-gray-500 text-center text-sm">Пожалуйста, выберите факультет и группу для просмотра расписания.</p>`;
                return;
            }

            const selectedGroup = groups.find(g => g.id === selectedGroupId);
            if (!selectedGroup) {
                 scheduleList.innerHTML = `<p class="text-gray-500 text-center text-sm">Группа не найдена.</p>`;
                return;
            }
            
            let filteredSchedule = schedule.filter(item => item.groupName === selectedGroup.name);

            if (dayFilterValue === 'today') {
                const today = new Date().getDay(); // 0 for Sunday, 1 for Monday, etc.
                const todayName = daysOfWeek[today];
                filteredSchedule = filteredSchedule.filter(item => item.day === todayName);
            }

            if (weekTypeFilterValue !== 'all') {
                filteredSchedule = filteredSchedule.filter(item => item.weekType === weekTypeFilterValue || item.weekType === 'all');
            }

            filteredSchedule.sort((a, b) => {
                const dayA = daysOfWeek.indexOf(a.day);
                const dayB = daysOfWeek.indexOf(b.day);
                if (dayA !== dayB) {
                    return dayA - dayB;
                }
                const timeA = a.time;
                const timeB = b.time;
                return timeA.localeCompare(timeB);
            });

            if (filteredSchedule.length === 0) {
                scheduleList.innerHTML = `<p class="text-gray-500 text-center text-sm">Для этой группы нет расписания на выбранные дни.</p>`;
                return;
            }

            let currentDay = '';
            filteredSchedule.forEach(item => {
                if (item.day !== currentDay) {
                    const dayHeader = document.createElement('h3');
                    dayHeader.className = 'text-xl font-semibold text-gray-800 mt-4 border-b pb-2';
                    dayHeader.textContent = item.day;
                    scheduleList.appendChild(dayHeader);
                    currentDay = item.day;
                }
                const weekBadgeClass = item.weekType === 'all' ? 'all' : item.weekType === 'odd' ? 'odd' : 'even';
                const itemEl = document.createElement('div');
                itemEl.className = 'bg-white p-4 rounded-xl shadow-md flex items-center justify-between';
                itemEl.innerHTML = `
                    <div>
                        <span class="text-sm text-gray-500">${item.time}</span>
                        <h4 class="font-medium text-lg text-gray-900">${item.subject}</h4>
                    </div>
                    <span class="week-badge ${weekBadgeClass}">${item.weekType === 'all' ? 'Все недели' : item.weekType === 'odd' ? 'Нечетная' : 'Четная'}</span>
                `;
                scheduleList.appendChild(itemEl);
            });
        }

        function renderScheduleAdminList() {
            scheduleAdminList.innerHTML = '';
            const selectedGroupId = groupSelect.value;
            if (!selectedGroupId) {
                 scheduleAdminList.innerHTML = `<p class="text-gray-500 text-center text-sm">Выберите группу для редактирования расписания.</p>`;
                return;
            }
            
            const selectedGroup = groups.find(g => g.id === selectedGroupId);
            if (!selectedGroup) return;

            const filteredSchedule = schedule.filter(item => item.groupName === selectedGroup.name);

            if (filteredSchedule.length === 0) {
                 scheduleAdminList.innerHTML = `<p class="text-gray-500 text-center text-sm">Для этой группы нет записей в расписании.</p>`;
                return;
            }
            
            const daysOfWeek = ['Воскресенье', 'Понедельник', 'Вторник', 'Среда', 'Четверг', 'Пятница', 'Суббота'];
            
            filteredSchedule.sort((a, b) => {
                const dayA = daysOfWeek.indexOf(a.day);
                const dayB = daysOfWeek.indexOf(b.day);
                if (dayA !== dayB) return dayA - dayB;
                return a.time.localeCompare(b.time);
            });

            let currentDay = '';
            filteredSchedule.forEach(item => {
                if (item.day !== currentDay) {
                    const dayHeader = document.createElement('h3');
                    dayHeader.className = 'text-xl font-semibold text-gray-800 mt-4 border-b pb-2';
                    dayHeader.textContent = item.day;
                    scheduleAdminList.appendChild(dayHeader);
                    currentDay = item.day;
                }
                const weekBadgeClass = item.weekType === 'all' ? 'all' : item.weekType === 'odd' ? 'odd' : 'even';
                const itemEl = document.createElement('div');
                itemEl.className = 'bg-white p-4 rounded-xl shadow-md flex items-center justify-between';
                itemEl.innerHTML = `
                    <div>
                        <span class="text-sm text-gray-500">${item.time}</span>
                        <h4 class="font-medium text-lg text-gray-900">${item.subject}</h4>
                    </div>
                    <div>
                         <span class="week-badge ${weekBadgeClass}">${item.weekType === 'all' ? 'Все' : item.weekType === 'odd' ? 'Нечетная' : 'Четная'}</span>
                         <button class="edit-schedule-btn text-blue-500 hover:text-blue-700 font-medium transition-colors duration-200 mr-2" data-id="${item.id}">Редактировать</button>
                         <button class="delete-schedule-btn text-red-500 hover:text-red-700 font-medium transition-colors duration-200" data-id="${item.id}">Удалить</button>
                    </div>
                `;
                scheduleAdminList.appendChild(itemEl);
            });
        }


        // --- EVENT LISTENERS ---

        // Main navigation
        showAdminButton.addEventListener('click', () => showPage('admin_page'));
        backButton.addEventListener('click', goBack);
        document.getElementById('showFacultiesButton').addEventListener('click', () => showPage('faculties_page'));
        document.getElementById('showGroupsButton').addEventListener('click', () => showPage('groups_page'));
        document.getElementById('showScheduleAdminButton').addEventListener('click', () => showPage('schedule_admin_page'));

        // Schedule filters
        facultyFilter.addEventListener('change', () => {
            renderGroupFilters();
            renderSchedule();
        });
        groupFilter.addEventListener('change', renderSchedule);
        dayFilter.addEventListener('change', renderSchedule);
        weekTypeFilter.addEventListener('change', renderSchedule);
        
        // Admin functions
        document.getElementById('addFacultyButton').addEventListener('click', () => {
            currentFacultyId = null;
            document.getElementById('facultyFormTitle').textContent = 'Добавить факультет';
            facultyNameInput.value = '';
            facultyGroupsSection.classList.add('hidden');
            showPage('faculty_edit_page');
        });

        document.getElementById('addGroupButton').addEventListener('click', () => {
            currentGroupId = null;
            document.getElementById('groupFormTitle').textContent = 'Добавить группу';
            groupNameInput.value = '';
            showPage('group_edit_page');
        });
        
        // Save/Update Faculty
        document.getElementById('saveFacultyButton').addEventListener('click', async () => {
            const name = facultyNameInput.value.trim();
            if (!name) {
                showMessage('Название факультета не может быть пустым.', 'error');
                return;
            }

            try {
                if (currentFacultyId) {
                    await updateDoc(doc(db, `artifacts/${appId}/public/data/faculties`, currentFacultyId), { name });
                    showMessage('Факультет успешно обновлен.', 'success');
                } else {
                    await addDoc(collection(db, `artifacts/${appId}/public/data/faculties`), { name });
                    showMessage('Факультет успешно добавлен.', 'success');
                }
                showPage('faculties_page');
            } catch (e) {
                console.error("Error saving faculty:", e);
                showMessage('Ошибка при сохранении факультета.', 'error');
            }
        });

        // Save/Update Group
        document.getElementById('saveGroupButton').addEventListener('click', async () => {
            const name = groupNameInput.value.trim();
            if (!name) {
                showMessage('Название группы не может быть пустым.', 'error');
                return;
            }

            try {
                if (currentGroupId) {
                    await updateDoc(doc(db, `artifacts/${appId}/public/data/groups`, currentGroupId), { name });
                    showMessage('Группа успешно обновлена.', 'success');
                } else {
                    await addDoc(collection(db, `artifacts/${appId}/public/data/groups`), { name, facultyId: null });
                    showMessage('Группа успешно добавлена.', 'success');
                }
                showPage('groups_page');
            } catch (e) {
                console.error("Error saving group:", e);
                showMessage('Ошибка при сохранении группы.', 'error');
            }
        });

        // Edit/Delete Faculty (delegated events)
        facultiesList.addEventListener('click', async (e) => {
            const id = e.target.dataset.id;
            if (!id) return;

            if (e.target.classList.contains('edit-btn')) {
                const faculty = faculties.find(f => f.id === id);
                if (faculty) {
                    currentFacultyId = id;
                    document.getElementById('facultyFormTitle').textContent = 'Редактировать факультет';
                    facultyNameInput.value = faculty.name;
                    facultyGroupsSection.classList.remove('hidden');
                    renderFacultyGroups(id);
                    showPage('faculty_edit_page');
                }
            } else if (e.target.classList.contains('delete-btn')) {
                try {
                    // Remove facultyId from associated groups before deleting the faculty
                    const groupsInFaculty = groups.filter(g => g.facultyId === id);
                    for (const group of groupsInFaculty) {
                        await updateDoc(doc(db, `artifacts/${appId}/public/data/groups`, group.id), { facultyId: null });
                    }
                    await deleteDoc(doc(db, `artifacts/${appId}/public/data/faculties`, id));
                    showMessage('Факультет успешно удален.', 'success');
                } catch (e) {
                    console.error("Error deleting faculty:", e);
                    showMessage('Ошибка при удалении факультета.', 'error');
                }
            }
        });
        
        // Edit/Delete Group (delegated events)
        groupsList.addEventListener('click', async (e) => {
            const id = e.target.dataset.id;
            if (!id) return;
            
            if (e.target.classList.contains('edit-btn')) {
                const group = groups.find(g => g.id === id);
                if (group) {
                    currentGroupId = id;
                    document.getElementById('groupFormTitle').textContent = 'Редактировать группу';
                    groupNameInput.value = group.name;
                    showPage('group_edit_page');
                }
            } else if (e.target.classList.contains('delete-btn')) {
                try {
                    await deleteDoc(doc(db, `artifacts/${appId}/public/data/groups`, id));
                    // Remove all schedule entries for this group
                    const scheduleToDelete = schedule.filter(s => s.groupName === groups.find(g => g.id === id).name);
                    for (const entry of scheduleToDelete) {
                        await deleteDoc(doc(db, `artifacts/${appId}/public/data/schedule`, entry.id));
                    }
                    showMessage('Группа и её расписание успешно удалены.', 'success');
                } catch (e) {
                    console.error("Error deleting group:", e);
                    showMessage('Ошибка при удалении группы.', 'error');
                }
            }
        });
        
        // Add/Remove groups from faculty
        document.getElementById('addGroupsToFacultyButton').addEventListener('click', () => {
            renderAvailableGroups();
            addGroupsModal.classList.remove('hidden');
        });

        document.getElementById('closeModalButton').addEventListener('click', () => {
            addGroupsModal.classList.add('hidden');
        });

        availableGroupsList.addEventListener('click', async (e) => {
            if (e.target.classList.contains('add-group-btn')) {
                const groupId = e.target.dataset.groupId;
                try {
                    await updateDoc(doc(db, `artifacts/${appId}/public/data/groups`, groupId), { facultyId: currentFacultyId });
                    showMessage('Группа добавлена к факультету.', 'success');
                    renderFacultyGroups(currentFacultyId);
                    renderAvailableGroups();
                } catch (e) {
                    console.error("Error adding group to faculty:", e);
                    showMessage('Ошибка при добавлении группы к факультету.', 'error');
                }
            }
        });

        facultyGroupsList.addEventListener('click', async (e) => {
            if (e.target.classList.contains('remove-group-btn')) {
                const groupId = e.target.dataset.groupId;
                try {
                    await updateDoc(doc(db, `artifacts/${appId}/public/data/groups`, groupId), { facultyId: null });
                    showMessage('Группа удалена из факультета.', 'success');
                    renderFacultyGroups(currentFacultyId);
                    renderAvailableGroups();
                } catch (e) {
                    console.error("Error removing group from faculty:", e);
                    showMessage('Ошибка при удалении группы из факультета.', 'error');
                }
            }
        });

        // Schedule Admin Logic
        groupSelect.addEventListener('change', () => {
            renderScheduleAdminList();
        });

        addScheduleEntryButton.addEventListener('click', () => {
            currentScheduleEntryId = null;
            scheduleModalTitle.textContent = 'Добавить занятие';
            scheduleDayInput.value = 'Понедельник';
            scheduleTimeInput.value = '';
            scheduleSubjectInput.value = '';
            scheduleWeekTypeInput.value = 'all';
            scheduleModal.classList.remove('hidden');
        });
        
        closeScheduleModalButton.addEventListener('click', () => {
            scheduleModal.classList.add('hidden');
        });

        saveScheduleEntryButton.addEventListener('click', async () => {
            const selectedGroupId = groupSelect.value;
            if (!selectedGroupId) {
                showMessage('Пожалуйста, выберите группу.', 'error');
                return;
            }
            const selectedGroup = groups.find(g => g.id === selectedGroupId);
            if (!selectedGroup) return;

            const day = scheduleDayInput.value;
            const time = scheduleTimeInput.value;
            const subject = scheduleSubjectInput.value.trim();
            const weekType = scheduleWeekTypeInput.value;

            if (!day || !time || !subject || !weekType) {
                showMessage('Все поля должны быть заполнены.', 'error');
                return;
            }

            const newEntry = {
                day,
                time,
                subject,
                weekType,
                groupName: selectedGroup.name
            };

            try {
                if (currentScheduleEntryId) {
                    await updateDoc(doc(db, `artifacts/${appId}/public/data/schedule`, currentScheduleEntryId), newEntry);
                    showMessage('Запись расписания успешно обновлена.', 'success');
                } else {
                    await addDoc(collection(db, `artifacts/${appId}/public/data/schedule`), newEntry);
                    showMessage('Запись расписания успешно добавлена.', 'success');
                }
                scheduleModal.classList.add('hidden');
            } catch (e) {
                console.error("Error saving schedule entry:", e);
                showMessage('Ошибка при сохранении записи расписания.', 'error');
            }
        });

        scheduleAdminList.addEventListener('click', async (e) => {
            const id = e.target.dataset.id;
            if (!id) return;
            
            if (e.target.classList.contains('edit-schedule-btn')) {
                const entry = schedule.find(s => s.id === id);
                if (entry) {
                    currentScheduleEntryId = id;
                    scheduleModalTitle.textContent = 'Редактировать занятие';
                    scheduleDayInput.value = entry.day;
                    scheduleTimeInput.value = entry.time;
                    scheduleSubjectInput.value = entry.subject;
                    scheduleWeekTypeInput.value = entry.weekType;
                    scheduleModal.classList.remove('hidden');
                }
            } else if (e.target.classList.contains('delete-schedule-btn')) {
                try {
                    await deleteDoc(doc(db, `artifacts/${appId}/public/data/schedule`, id));
                    showMessage('Запись расписания успешно удалена.', 'success');
                } catch (e) {
                    console.error("Error deleting schedule entry:", e);
                    showMessage('Ошибка при удалении записи расписания.', 'error');
                }
            }
        });
    </script>
</body>
</html>
