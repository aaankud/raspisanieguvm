<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Управление Факультетами и Группами</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .page {
            display: none;
        }
        .page.active {
            display: block;
        }
        /* Style for the week type badge */
        .week-badge {
            font-size: 0.75rem;
            padding: 0.25rem 0.5rem;
            border-radius: 9999px;
            font-weight: 500;
            white-space: nowrap;
        }
        .week-badge.all {
            background-color: #d1d5db; /* gray-300 */
            color: #4b5563; /* gray-600 */
        }
        .week-badge.odd {
            background-color: #fca5a5; /* red-300 */
            color: #991b1b; /* red-800 */
        }
        .week-badge.even {
            background-color: #a5f3fc; /* cyan-300 */
            color: #0891b2; /* cyan-700 */
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen p-4 flex flex-col items-center">

    <div class="bg-white p-6 md:p-10 rounded-3xl shadow-2xl w-full max-w-2xl">
        
        <div class="flex justify-between items-center mb-6 border-b pb-4">
            <button id="backButton" class="text-gray-500 hover:text-gray-700 transition-colors duration-200 p-2 rounded-full hidden">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
                </svg>
            </button>
            <h1 id="pageTitle" class="text-3xl font-bold text-gray-900">Расписание</h1>
            <button id="showAdminButton" class="text-gray-500 hover:text-gray-700 transition-colors duration-200 p-2 rounded-full">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.527.272 1.092.427 1.724 1.066z" />
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                </svg>
            </button>
        </div>

        <div id="pagesContainer">
            
            <div id="schedule_page" class="page active">
                <div class="mb-4 space-y-4">
                    <div class="space-y-2">
                        <label for="facultyFilter" class="block text-sm font-medium text-gray-700">Факультет:</label>
                        <select id="facultyFilter" class="w-full p-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-purple-500">
                            </select>
                    </div>
                    <div class="space-y-2">
                        <label for="groupFilter" class="block text-sm font-medium text-gray-700">Группа:</label>
                        <select id="groupFilter" class="w-full p-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-purple-500">
                            </select>
                    </div>
                    <div class="space-y-2">
                        <label for="dayFilter" class="block text-sm font-medium text-gray-700">День:</label>
                        <select id="dayFilter" class="w-full p-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-purple-500">
                            <option value="all">Вся неделя</option>
                            <option value="today">Сегодня</option>
                        </select>
                    </div>
                    <div class="space-y-2">
                        <label for="weekTypeFilter" class="block text-sm font-medium text-gray-700">Тип недели:</label>
                        <select id="weekTypeFilter" class="w-full p-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-purple-500">
                            <option value="all">Все</option>
                            <option value="even">Четная</option>
                            <option value="odd">Нечетная</option>
                        </select>
                    </div>
                </div>
                <div id="scheduleList" class="space-y-6">
                    </div>
            </div>

            <div id="password_page" class="page">
                <div class="space-y-4">
                    <p class="text-gray-600 mb-6">Введите пароль для доступа к панели администратора.</p>
                    <input id="adminPasswordInput" type="password" placeholder="Пароль" class="w-full p-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-blue-500">
                    <button id="submitPasswordButton" class="w-full bg-blue-600 text-white font-semibold py-3 px-6 rounded-xl hover:bg-blue-700 transition-colors duration-200 shadow-md">
                        Войти
                    </button>
                </div>
            </div>

            <div id="admin_page" class="page">
                <p class="text-gray-600 mb-6">Панель администрирования. Здесь вы можете управлять данными.</p>
                <div class="space-y-4">
                    <button id="showFacultiesButton" class="w-full bg-blue-600 text-white font-semibold py-3 px-6 rounded-xl hover:bg-blue-700 transition-colors duration-200 shadow-md">
                        Управление факультетами
                    </button>
                    <button id="showGroupsButton" class="w-full bg-green-600 text-white font-semibold py-3 px-6 rounded-xl hover:bg-green-700 transition-colors duration-200 shadow-md">
                        Управление группами
                    </button>
                    <button id="showScheduleAdminButton" class="w-full bg-indigo-600 text-white font-semibold py-3 px-6 rounded-xl hover:bg-indigo-700 transition-colors duration-200 shadow-md">
                        Управление расписанием
                    </button>
                </div>
            </div>

            <div id="schedule_admin_page" class="page">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-semibold text-gray-800">Редактирование расписания</h2>
                    <button id="addScheduleEntryButton" class="bg-blue-500 text-white p-2 rounded-full hover:bg-blue-600 transition-colors duration-200 shadow-md">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
                        </svg>
                    </button>
                </div>
                <div class="space-y-2 mb-4">
                    <label for="groupSelect" class="block text-sm font-medium text-gray-700">Выберите группу:</label>
                    <select id="groupSelect" class="w-full p-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-purple-500">
                        </select>
                </div>
                <div id="scheduleAdminList" class="space-y-6">
                    </div>
            </div>

            <div id="faculties_page" class="page">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-semibold text-gray-800">Список факультетов</h2>
                    <button id="addFacultyButton" class="bg-blue-500 text-white p-2 rounded-full hover:bg-blue-600 transition-colors duration-200 shadow-md">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
                        </svg>
                    </button>
                </div>
                <div id="facultiesList" class="space-y-4">
                    </div>
            </div>

            <div id="groups_page" class="page">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-semibold text-gray-800">Список групп</h2>
                    <button id="addGroupButton" class="bg-blue-500 text-white p-2 rounded-full hover:bg-blue-600 transition-colors duration-200 shadow-md">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
                        </svg>
                    </button>
                </div>
                <div id="groupsList" class="space-y-4">
                    </div>
            </div>

            <div id="faculty_edit_page" class="page">
                <h2 id="facultyFormTitle" class="text-2xl font-semibold text-gray-800 mb-4"></h2>
                <input id="facultyNameInput" type="text" placeholder="Название факультета" class="w-full p-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-blue-500 mb-4">
                <button id="saveFacultyButton" class="w-full bg-blue-600 text-white font-semibold py-3 px-6 rounded-xl hover:bg-blue-700 transition-colors duration-200 shadow-md">
                    Сохранить
                </button>

                <div id="facultyGroupsSection" class="mt-8 pt-4 border-t border-gray-200 hidden">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xl font-semibold text-gray-800">Группы факультета</h3>
                        <button id="addGroupsToFacultyButton" class="bg-green-500 text-white p-2 rounded-full hover:bg-green-600 transition-colors duration-200 shadow-md">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
                            </svg>
                        </button>
                    </div>
                    <div id="facultyGroupsList" class="space-y-2">
                        </div>
                </div>
            </div>

            <div id="group_edit_page" class="page">
                <h2 id="groupFormTitle" class="text-2xl font-semibold text-gray-800 mb-4"></h2>
                <select id="groupFacultySelect" class="w-full p-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-purple-500 mb-4">
                    <option value="">Выберите факультет</option>
                </select>
                <input id="groupNameInput" type="text" placeholder="Название группы" class="w-full p-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-blue-500 mb-4">
                <button id="saveGroupButton" class="w-full bg-blue-600 text-white font-semibold py-3 px-6 rounded-xl hover:bg-blue-700 transition-colors duration-200 shadow-md">
                    Сохранить
                </button>
            </div>
            
            <div id="addGroupsModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden">
                <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-xl bg-white">
                    <div class="mt-3 text-center">
                        <h3 class="text-lg leading-6 font-medium text-gray-900">Добавить группы</h3>
                        <div class="mt-2 px-7 py-3">
                            <div id="availableGroupsList" class="space-y-2">
                                </div>
                        </div>
                        <div class="items-center px-4 py-3">
                            <button id="closeModalButton" class="px-4 py-2 bg-gray-200 text-gray-700 text-base font-medium rounded-xl hover:bg-gray-300 transition-colors duration-200 w-full">
                                Закрыть
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <div id="scheduleModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden">
                <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-xl bg-white">
                    <div class="mt-3 text-center">
                        <h3 id="scheduleModalTitle" class="text-lg leading-6 font-medium text-gray-900">Добавить занятие</h3>
                        <div class="mt-2 px-7 py-3 space-y-4">
                            <select id="scheduleDayInput" class="w-full p-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-purple-500">
                                <option value="Понедельник">Понедельник</option>
                                <option value="Вторник">Вторник</option>
                                <option value="Среда">Среда</option>
                                <option value="Четверг">Четверг</option>
                                <option value="Пятница">Пятница</option>
                                <option value="Суббота">Суббота</option>
                                <option value="Воскресенье">Воскресенье</option>
                            </select>
                            <input id="scheduleTimeInput" type="time" class="w-full p-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-blue-500">
                            <input id="scheduleSubjectInput" type="text" placeholder="Название предмета" class="w-full p-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-blue-500">
                            <select id="scheduleWeekTypeInput" class="w-full p-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-purple-500">
                                <option value="all">Для всех недель</option>
                                <option value="even">Четная неделя</option>
                                <option value="odd">Нечетная неделя</option>
                            </select>
                        </div>
                        <div class="items-center px-4 py-3">
                            <button id="saveScheduleEntryButton" class="px-4 py-2 bg-blue-600 text-white text-base font-medium rounded-xl hover:bg-blue-700 transition-colors duration-200 w-full mb-2">
                                Сохранить
                            </button>
                            <button id="closeScheduleModalButton" class="px-4 py-2 bg-gray-200 text-gray-700 text-base font-medium rounded-xl hover:bg-gray-300 transition-colors duration-200 w-full">
                                Отмена
                            </button>
                        </div>
                    </div>
                </div>
            </div>

        </div>

        <div id="messageBox" class="mt-8 p-4 rounded-xl text-center font-medium transition-opacity duration-300 opacity-0"></div>

    </div>

    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-firestore-compat.js"></script>
    <script>
        // --- FIREBASE CONFIGURATION ---
        const firebaseConfig = {
            apiKey: "AIzaSyB2kuT1fSPp4kBKeEad_rYXMqh27z2KDO0",
            authDomain: "raspisanie-c90b6.firebaseapp.com",
            projectId: "raspisanie-c90b6",
            storageBucket: "raspisanie-c90b6.firebasestorage.app",
            messagingSenderId: "867699750609",
            appId: "1:867699750609:web:6cbf1c0c8bfa429b0337f0",
            measurementId: "G-JDF8DNGFZT"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // --- DATA AND STATE MANAGEMENT ---
        const ADMIN_PASSWORD = 'admin';
        let faculties = [];
        let groups = [];
        let schedule = [];

        let currentFacultyId = null;
        let currentGroupId = null;
        let currentScheduleEntryId = null;

        // --- NAVIGATION STATE ---
        const pageHistory = ['schedule_page'];
        const pageTitle = document.getElementById('pageTitle');
        
        // --- DOM ELEMENTS ---
        const pages = document.querySelectorAll('.page');
        const showAdminButton = document.getElementById('showAdminButton');
        const showScheduleAdminButton = document.getElementById('showScheduleAdminButton');
        const backButton = document.getElementById('backButton');
        const facultiesList = document.getElementById('facultiesList');
        const groupsList = document.getElementById('groupsList');
        const scheduleList = document.getElementById('scheduleList');
        const facultyFilter = document.getElementById('facultyFilter');
        const groupFilter = document.getElementById('groupFilter');
        const dayFilter = document.getElementById('dayFilter');
        const weekTypeFilter = document.getElementById('weekTypeFilter');
        const facultyNameInput = document.getElementById('facultyNameInput');
        const groupNameInput = document.getElementById('groupNameInput');
        const groupFacultySelect = document.getElementById('groupFacultySelect');
        const facultyGroupsSection = document.getElementById('facultyGroupsSection');
        const facultyGroupsList = document.getElementById('facultyGroupsList');
        const addGroupsModal = document.getElementById('addGroupsModal');
        const availableGroupsList = document.getElementById('availableGroupsList');
        const adminPasswordInput = document.getElementById('adminPasswordInput');
        const messageBox = document.getElementById('messageBox');
        
        // Schedule admin elements
        const groupSelect = document.getElementById('groupSelect');
        const scheduleAdminList = document.getElementById('scheduleAdminList');
        const addScheduleEntryButton = document.getElementById('addScheduleEntryButton');
        const scheduleModal = document.getElementById('scheduleModal');
        const scheduleModalTitle = document.getElementById('scheduleModalTitle');
        const scheduleDayInput = document.getElementById('scheduleDayInput');
        const scheduleTimeInput = document.getElementById('scheduleTimeInput');
        const scheduleSubjectInput = document.getElementById('scheduleSubjectInput');
        const scheduleWeekTypeInput = document.getElementById('scheduleWeekTypeInput');
        const saveScheduleEntryButton = document.getElementById('saveScheduleEntryButton');
        const closeScheduleModalButton = document.getElementById('closeScheduleModalButton');

        // --- TELEGRAM WEB APP INTEGRATION ---
        const WebApp = window.Telegram.WebApp;

        WebApp.ready();
        WebApp.onEvent('backButtonClicked', goBack);

        // --- CORE FUNCTIONS ---
        function showPage(pageId) {
            pages.forEach(page => page.classList.remove('active'));
            document.getElementById(pageId).classList.add('active');
            
            if (pageHistory[pageHistory.length - 1] !== pageId) {
                pageHistory.push(pageId);
            }
            
            updateNavigationUI();
            
            if (pageId === 'faculties_page') {
                renderFaculties();
            } else if (pageId === 'groups_page') {
                renderGroups();
            } else if (pageId === 'schedule_page') {
                renderSchedule();
            } else if (pageId === 'schedule_admin_page') {
                renderGroupSelect();
                renderScheduleAdminList();
            } else if (pageId === 'group_edit_page') {
                renderGroupFacultySelect();
            }
        }

        function goBack() {
            if (pageHistory.length > 1) {
                pageHistory.pop();
                const lastPageId = pageHistory[pageHistory.length - 1];
                pages.forEach(page => page.classList.remove('active'));
                document.getElementById(lastPageId).classList.add('active');
                updateNavigationUI();
                
                if (lastPageId === 'faculties_page') {
                    renderFaculties();
                } else if (lastPageId === 'groups_page') {
                    renderGroups();
                } else if (lastPageId === 'schedule_page') {
                    renderSchedule();
                }
            } else {
                WebApp.close();
            }
        }

        function updateNavigationUI() {
            if (pageHistory.length > 1) {
                WebApp.BackButton.show();
                showAdminButton.classList.add('hidden');
                backButton.classList.remove('hidden');
            } else {
                WebApp.BackButton.hide();
                showAdminButton.classList.remove('hidden');
                backButton.classList.add('hidden');
            }

            const currentPage = pageHistory[pageHistory.length - 1];
            switch (currentPage) {
                case 'schedule_page':
                    pageTitle.textContent = 'Расписание';
                    break;
                case 'password_page':
                    pageTitle.textContent = 'Вход';
                    break;
                case 'admin_page':
                    pageTitle.textContent = 'Администрирование';
                    break;
                case 'faculties_page':
                    pageTitle.textContent = 'Факультеты';
                    break;
                case 'groups_page':
                    pageTitle.textContent = 'Группы';
                    break;
                case 'schedule_admin_page':
                    pageTitle.textContent = 'Редактирование расписания';
                    break;
                case 'faculty_edit_page':
                    pageTitle.textContent = 'Редактирование факультета';
                    break;
                case 'group_edit_page':
                    pageTitle.textContent = 'Редактирование группы';
                    break;
                default:
                    pageTitle.textContent = 'Страница';
            }
        }
        
        function showMessage(message, type) {
            messageBox.textContent = message;
            messageBox.classList.remove('opacity-0', 'bg-red-200', 'text-red-800', 'bg-green-200', 'text-green-800', 'bg-blue-200', 'text-blue-800');
            if (type === 'success') {
                messageBox.classList.add('bg-green-200', 'text-green-800');
            } else if (type === 'error') {
                messageBox.classList.add('bg-red-200', 'text-red-800');
            } else {
                messageBox.classList.add('bg-blue-200', 'text-blue-800');
            }
            messageBox.classList.add('opacity-100');
            setTimeout(() => {
                messageBox.classList.remove('opacity-100');
                messageBox.classList.add('opacity-0');
            }, 3000);
        }

        // --- RENDERING FUNCTIONS ---

        function renderFaculties() {
            facultiesList.innerHTML = '';
            faculties.forEach(faculty => {
                const facultyGroupsCount = groups.filter(g => g.facultyId === faculty.id).length;
                const item = document.createElement('div');
                item.className = 'flex items-center justify-between bg-gray-50 p-4 rounded-xl shadow-sm';
                item.innerHTML = `
                    <div>
                        <h3 class="font-semibold text-gray-900">${faculty.name}</h3>
                        <p class="text-sm text-gray-500">${facultyGroupsCount} групп(а)</p>
                    </div>
                    <div>
                        <button class="edit-btn text-blue-500 hover:text-blue-700 font-medium transition-colors duration-200 mr-2" data-id="${faculty.id}">Редактировать</button>
                        <button class="delete-btn text-red-500 hover:text-red-700 font-medium transition-colors duration-200" data-id="${faculty.id}">Удалить</button>
                    </div>
                `;
                facultiesList.appendChild(item);
            });
        }

        function renderGroups() {
            groupsList.innerHTML = '';
            groups.forEach(group => {
                const faculty = faculties.find(f => f.id === group.facultyId);
                const facultyName = faculty ? faculty.name : 'Без факультета';
                const item = document.createElement('div');
                item.className = 'flex items-center justify-between bg-gray-50 p-4 rounded-xl shadow-sm';
                item.innerHTML = `
                    <div>
                        <h3 class="font-semibold text-gray-900">${group.name}</h3>
                        <p class="text-sm text-gray-500">${facultyName}</p>
                    </div>
                    <div>
                        <button class="edit-btn text-blue-500 hover:text-blue-700 font-medium transition-colors duration-200 mr-2" data-id="${group.id}">Редактировать</button>
                        <button class="delete-btn text-red-500 hover:text-red-700 font-medium transition-colors duration-200" data-id="${group.id}">Удалить</button>
                    </div>
                `;
                groupsList.appendChild(item);
            });
        }

        function renderGroupFacultySelect() {
            groupFacultySelect.innerHTML = '<option value="">Выберите факультет</option>';
            faculties.forEach(faculty => {
                const option = document.createElement('option');
                option.value = faculty.id;
                option.textContent = faculty.name;
                groupFacultySelect.appendChild(option);
            });
        }

        function renderFacultyGroups(facultyId) {
            facultyGroupsList.innerHTML = '';
            const facultyGroups = groups.filter(g => g.facultyId === facultyId);
            if (facultyGroups.length === 0) {
                facultyGroupsList.innerHTML = `<p class="text-gray-500 text-sm">В этом факультете пока нет групп.</p>`;
            }
            facultyGroups.forEach(group => {
                const item = document.createElement('div');
                item.className = 'flex items-center justify-between bg-white p-3 rounded-lg border border-gray-200';
                item.innerHTML = `
                    <span class="text-gray-800">${group.name}</span>
                    <button class="remove-group-btn text-red-500 hover:text-red-700 text-sm font-medium transition-colors duration-200" data-group-id="${group.id}">Убрать</button>
                `;
                facultyGroupsList.appendChild(item);
            });
        }

        function renderAvailableGroups() {
            availableGroupsList.innerHTML = '';
            const availableGroups = groups.filter(g => g.facultyId === null || g.facultyId === "");
            if (availableGroups.length === 0) {
                availableGroupsList.innerHTML = `<p class="text-gray-500 text-sm">Все группы уже привязаны к факультетам.</p>`;
            }
            availableGroups.forEach(group => {
                const item = document.createElement('div');
                item.className = 'flex items-center justify-between bg-gray-50 p-3 rounded-lg border border-gray-200';
                item.innerHTML = `
                    <span class="text-gray-800">${group.name}</span>
                    <button class="add-group-btn bg-green-500 text-white text-sm font-medium py-1 px-3 rounded-lg hover:bg-green-600 transition-colors duration-200" data-group-id="${group.id}">Добавить</button>
                `;
                availableGroupsList.appendChild(item);
            });
        }

        function renderSchedule() {
            scheduleList.innerHTML = '';
            renderFacultyAndGroupFilters(); // Re-render filters
            const selectedFacultyId = facultyFilter.value === 'all' ? null : facultyFilter.value;
            const selectedGroupId = groupFilter.value === 'all' ? null : groupFilter.value;
            const dayFilterValue = dayFilter.value;
            const weekTypeFilterValue = weekTypeFilter.value;
            const daysOfWeek = ['Воскресенье', 'Понедельник', 'Вторник', 'Среда', 'Четверг', 'Пятница', 'Суббота'];
            
            if (!selectedGroupId) {
                scheduleList.innerHTML = `<p class="text-gray-500 text-center text-sm">Пожалуйста, выберите факультет и группу для просмотра расписания.</p>`;
                return;
            }

            const selectedGroup = groups.find(g => g.id === selectedGroupId);
            let filteredSchedule = [];

            if (selectedGroup) {
                filteredSchedule = schedule.filter(item => item.group === selectedGroup.name);
            }

            if (dayFilterValue === 'today') {
                const today = new Date().getDay();
                const todayName = daysOfWeek[today];
                filteredSchedule = filteredSchedule.filter(item => item.day === todayName);
            }

            if (weekTypeFilterValue !== 'all') {
                filteredSchedule = filteredSchedule.filter(item => item.weekType === weekTypeFilterValue || item.weekType === 'all');
            }

            filteredSchedule.sort((a, b) => {
                const dayA = daysOfWeek.indexOf(a.day);
                const dayB = daysOfWeek.indexOf(b.day);
                if (dayA !== dayB) {
                    return dayA - dayB;
                }
                const timeA = a.time.split(':').map(Number);
                const timeB = b.time.split(':').map(Number);
                if (timeA[0] !== timeB[0]) {
                    return timeA[0] - timeB[0];
                }
                return timeA[1] - timeB[1];
            });

            if (filteredSchedule.length === 0) {
                scheduleList.innerHTML = `<p class="text-gray-500 text-center text-sm">Расписание не найдено.</p>`;
                return;
            }

            let currentDay = '';
            filteredSchedule.forEach(item => {
                if (item.day !== currentDay) {
                    const dayHeader = document.createElement('h3');
                    dayHeader.className = 'text-xl font-semibold text-gray-800 mt-4 mb-2 first:mt-0';
                    dayHeader.textContent = item.day;
                    scheduleList.appendChild(dayHeader);
                    currentDay = item.day;
                }
                const badgeClass = item.weekType === 'odd' ? 'odd' : item.weekType === 'even' ? 'even' : 'all';
                const badgeText = item.weekType === 'odd' ? 'Нечетная' : item.weekType === 'even' ? 'Четная' : 'Все недели';
                const entry = document.createElement('div');
                entry.className = 'bg-white p-4 rounded-xl shadow-sm flex items-center justify-between';
                entry.innerHTML = `
                    <div>
                        <div class="flex items-center space-x-2">
                            <span class="text-lg font-semibold text-gray-900">${item.subject}</span>
                            <span class="week-badge ${badgeClass}">${badgeText}</span>
                        </div>
                        <p class="text-sm text-gray-600">${item.time}</p>
                    </div>
                `;
                scheduleList.appendChild(entry);
            });
        }

        function renderFacultyAndGroupFilters() {
            // Populate Faculty Filter
            facultyFilter.innerHTML = '<option value="all">Все факультеты</option>';
            faculties.forEach(f => {
                const option = document.createElement('option');
                option.value = f.id;
                option.textContent = f.name;
                facultyFilter.appendChild(option);
            });

            // Populate Group Filter based on selected faculty
            const selectedFacultyId = facultyFilter.value === 'all' ? null : facultyFilter.value;
            groupFilter.innerHTML = '<option value="all">Все группы</option>';
            const groupsToDisplay = selectedFacultyId ? groups.filter(g => g.facultyId === selectedFacultyId) : groups;
            groupsToDisplay.forEach(g => {
                const option = document.createElement('option');
                option.value = g.id;
                option.textContent = g.name;
                groupFilter.appendChild(option);
            });
        }

        function renderGroupSelect() {
            groupSelect.innerHTML = '';
            groups.forEach(group => {
                const option = document.createElement('option');
                option.value = group.id;
                option.textContent = group.name;
                groupSelect.appendChild(option);
            });
            currentGroupId = groupSelect.value;
            renderScheduleAdminList();
        }

        function renderScheduleAdminList() {
            scheduleAdminList.innerHTML = '';
            if (!currentGroupId) {
                scheduleAdminList.innerHTML = `<p class="text-gray-500 text-center text-sm">Выберите группу для управления расписанием.</p>`;
                return;
            }

            const selectedGroup = groups.find(g => g.id === currentGroupId);
            if (!selectedGroup) return;

            const filteredSchedule = schedule.filter(item => item.group === selectedGroup.name);
            const daysOfWeek = ['Понедельник', 'Вторник', 'Среда', 'Четверг', 'Пятница', 'Суббота', 'Воскресенье'];
            filteredSchedule.sort((a, b) => {
                const dayA = daysOfWeek.indexOf(a.day);
                const dayB = daysOfWeek.indexOf(b.day);
                if (dayA !== dayB) return dayA - dayB;
                return a.time.localeCompare(b.time);
            });

            if (filteredSchedule.length === 0) {
                scheduleAdminList.innerHTML = `<p class="text-gray-500 text-center text-sm">Расписание для этой группы пока пусто.</p>`;
                return;
            }

            let currentDay = '';
            filteredSchedule.forEach(item => {
                if (item.day !== currentDay) {
                    const dayHeader = document.createElement('h3');
                    dayHeader.className = 'text-xl font-semibold text-gray-800 mt-4 mb-2 first:mt-0';
                    dayHeader.textContent = item.day;
                    scheduleAdminList.appendChild(dayHeader);
                    currentDay = item.day;
                }
                const entry = document.createElement('div');
                entry.className = 'bg-white p-4 rounded-xl shadow-sm flex items-center justify-between';
                entry.innerHTML = `
                    <div>
                        <div class="flex items-center space-x-2">
                            <span class="text-lg font-semibold text-gray-900">${item.subject}</span>
                            <span class="week-badge ${item.weekType === 'odd' ? 'odd' : item.weekType === 'even' ? 'even' : 'all'}">${item.weekType === 'odd' ? 'Нечетная' : item.weekType === 'even' ? 'Четная' : 'Все'}</span>
                        </div>
                        <p class="text-sm text-gray-600">${item.time}</p>
                    </div>
                    <div>
                        <button class="edit-schedule-btn text-blue-500 hover:text-blue-700 font-medium transition-colors duration-200 mr-2" data-id="${item.id}">Изменить</button>
                        <button class="delete-schedule-btn text-red-500 hover:text-red-700 font-medium transition-colors duration-200" data-id="${item.id}">Удалить</button>
                    </div>
                `;
                scheduleAdminList.appendChild(entry);
            });
        }


        // --- EVENT LISTENERS ---

        // General navigation
        showAdminButton.addEventListener('click', () => showPage('password_page'));
        backButton.addEventListener('click', goBack);
        
        // Admin password
        document.getElementById('submitPasswordButton').addEventListener('click', () => {
            if (adminPasswordInput.value === ADMIN_PASSWORD) {
                showPage('admin_page');
                adminPasswordInput.value = '';
            } else {
                showMessage("Неверный пароль", "error");
            }
        });
        
        // Admin page buttons
        document.getElementById('showFacultiesButton').addEventListener('click', () => showPage('faculties_page'));
        document.getElementById('showGroupsButton').addEventListener('click', () => showPage('groups_page'));
        document.getElementById('showScheduleAdminButton').addEventListener('click', () => {
            showPage('schedule_admin_page');
            renderGroupSelect();
        });

        // Faculty management
        document.getElementById('addFacultyButton').addEventListener('click', () => {
            currentFacultyId = null;
            document.getElementById('facultyFormTitle').textContent = 'Добавить факультет';
            facultyNameInput.value = '';
            facultyGroupsSection.classList.add('hidden');
            showPage('faculty_edit_page');
        });
        
        facultiesList.addEventListener('click', (event) => {
            if (event.target.classList.contains('edit-btn')) {
                currentFacultyId = event.target.dataset.id;
                const faculty = faculties.find(f => f.id === currentFacultyId);
                if (faculty) {
                    document.getElementById('facultyFormTitle').textContent = 'Редактировать факультет';
                    facultyNameInput.value = faculty.name;
                    facultyGroupsSection.classList.remove('hidden');
                    renderFacultyGroups(currentFacultyId);
                    showPage('faculty_edit_page');
                }
            } else if (event.target.classList.contains('delete-btn')) {
                const facultyId = event.target.dataset.id;
                db.collection("faculties").doc(facultyId).delete()
                    .then(() => showMessage("Факультет успешно удален", "success"))
                    .catch(error => showMessage("Ошибка при удалении: " + error, "error"));
            }
        });

        document.getElementById('saveFacultyButton').addEventListener('click', () => {
            const facultyName = facultyNameInput.value.trim();
            if (facultyName) {
                if (currentFacultyId) {
                    db.collection("faculties").doc(currentFacultyId).update({ name: facultyName })
                        .then(() => {
                            showMessage("Факультет успешно обновлен", "success");
                            showPage('faculties_page');
                        })
                        .catch(error => showMessage("Ошибка при обновлении: " + error, "error"));
                } else {
                    db.collection("faculties").add({ name: facultyName })
                        .then(() => {
                            showMessage("Факультет успешно добавлен", "success");
                            showPage('faculties_page');
                        })
                        .catch(error => showMessage("Ошибка при добавлении: " + error, "error"));
                }
            }
        });

        // Group management
        document.getElementById('addGroupButton').addEventListener('click', () => {
            currentGroupId = null;
            document.getElementById('groupFormTitle').textContent = 'Добавить группу';
            groupNameInput.value = '';
            groupFacultySelect.value = '';
            showPage('group_edit_page');
        });

        groupsList.addEventListener('click', (event) => {
            if (event.target.classList.contains('edit-btn')) {
                currentGroupId = event.target.dataset.id;
                const group = groups.find(g => g.id === currentGroupId);
                if (group) {
                    document.getElementById('groupFormTitle').textContent = 'Редактировать группу';
                    groupNameInput.value = group.name;
                    groupFacultySelect.value = group.facultyId || '';
                    showPage('group_edit_page');
                }
            } else if (event.target.classList.contains('delete-btn')) {
                const groupId = event.target.dataset.id;
                db.collection("groups").doc(groupId).delete()
                    .then(() => showMessage("Группа успешно удалена", "success"))
                    .catch(error => showMessage("Ошибка при удалении: " + error, "error"));
            }
        });

        document.getElementById('saveGroupButton').addEventListener('click', () => {
            const groupName = groupNameInput.value.trim();
            const facultyId = groupFacultySelect.value || null;
            if (groupName) {
                if (currentGroupId) {
                    db.collection("groups").doc(currentGroupId).update({ name: groupName, facultyId: facultyId })
                        .then(() => {
                            showMessage("Группа успешно обновлена", "success");
                            showPage('groups_page');
                        })
                        .catch(error => showMessage("Ошибка при обновлении: " + error, "error"));
                } else {
                    db.collection("groups").add({ name: groupName, facultyId: facultyId })
                        .then(() => {
                            showMessage("Группа успешно добавлена", "success");
                            showPage('groups_page');
                        })
                        .catch(error => showMessage("Ошибка при добавлении: " + error, "error"));
                }
            }
        });

        // Add/remove groups from faculty
        document.getElementById('addGroupsToFacultyButton').addEventListener('click', () => {
            renderAvailableGroups();
            addGroupsModal.classList.remove('hidden');
        });

        document.getElementById('closeModalButton').addEventListener('click', () => {
            addGroupsModal.classList.add('hidden');
        });

        availableGroupsList.addEventListener('click', (event) => {
            if (event.target.classList.contains('add-group-btn')) {
                const groupId = event.target.dataset.groupId;
                db.collection("groups").doc(groupId).update({ facultyId: currentFacultyId })
                    .then(() => {
                        showMessage("Группа добавлена к факультету", "success");
                        renderFacultyGroups(currentFacultyId);
                        renderAvailableGroups();
                    })
                    .catch(error => showMessage("Ошибка: " + error, "error"));
            }
        });

        facultyGroupsList.addEventListener('click', (event) => {
            if (event.target.classList.contains('remove-group-btn')) {
                const groupId = event.target.dataset.groupId;
                db.collection("groups").doc(groupId).update({ facultyId: null })
                    .then(() => {
                        showMessage("Группа успешно убрана", "success");
                        renderFacultyGroups(currentFacultyId);
                    })
                    .catch(error => showMessage("Ошибка: " + error, "error"));
            }
        });

        // Schedule management
        groupSelect.addEventListener('change', () => {
            currentGroupId = groupSelect.value;
            renderScheduleAdminList();
        });

        addScheduleEntryButton.addEventListener('click', () => {
            currentScheduleEntryId = null;
            scheduleModalTitle.textContent = 'Добавить занятие';
            scheduleDayInput.value = 'Понедельник';
            scheduleTimeInput.value = '09:00';
            scheduleSubjectInput.value = '';
            scheduleWeekTypeInput.value = 'all';
            scheduleModal.classList.remove('hidden');
        });

        closeScheduleModalButton.addEventListener('click', () => {
            scheduleModal.classList.add('hidden');
        });

        scheduleAdminList.addEventListener('click', (event) => {
            if (event.target.classList.contains('edit-schedule-btn')) {
                currentScheduleEntryId = event.target.dataset.id;
                const entry = schedule.find(item => item.id === currentScheduleEntryId);
                if (entry) {
                    scheduleModalTitle.textContent = 'Изменить занятие';
                    scheduleDayInput.value = entry.day;
                    scheduleTimeInput.value = entry.time;
                    scheduleSubjectInput.value = entry.subject;
                    scheduleWeekTypeInput.value = entry.weekType;
                    scheduleModal.classList.remove('hidden');
                }
            } else if (event.target.classList.contains('delete-schedule-btn')) {
                const entryId = event.target.dataset.id;
                db.collection("schedule").doc(entryId).delete()
                    .then(() => showMessage("Запись расписания удалена", "success"))
                    .catch(error => showMessage("Ошибка при удалении: " + error, "error"));
            }
        });

        saveScheduleEntryButton.addEventListener('click', () => {
            const selectedGroup = groups.find(g => g.id === currentGroupId);
            if (!selectedGroup) {
                showMessage("Выберите группу", "error");
                return;
            }

            const scheduleEntry = {
                day: scheduleDayInput.value,
                time: scheduleTimeInput.value,
                subject: scheduleSubjectInput.value,
                weekType: scheduleWeekTypeInput.value,
                group: selectedGroup.name
            };

            if (currentScheduleEntryId) {
                db.collection("schedule").doc(currentScheduleEntryId).update(scheduleEntry)
                    .then(() => {
                        showMessage("Расписание обновлено", "success");
                        scheduleModal.classList.add('hidden');
                    })
                    .catch(error => showMessage("Ошибка при обновлении: " + error, "error"));
            } else {
                db.collection("schedule").add(scheduleEntry)
                    .then(() => {
                        showMessage("Занятие добавлено", "success");
                        scheduleModal.classList.add('hidden');
                    })
                    .catch(error => showMessage("Ошибка при добавлении: " + error, "error"));
            }
        });

        // User filters
        facultyFilter.addEventListener('change', () => {
            const selectedFacultyId = facultyFilter.value;
            groupFilter.innerHTML = '<option value="all">Все группы</option>';
            const groupsToDisplay = selectedFacultyId === 'all' ? groups : groups.filter(g => g.facultyId === selectedFacultyId);
            groupsToDisplay.forEach(g => {
                const option = document.createElement('option');
                option.value = g.id;
                option.textContent = g.name;
                groupFilter.appendChild(option);
            });
            renderSchedule();
        });

        groupFilter.addEventListener('change', renderSchedule);
        dayFilter.addEventListener('change', renderSchedule);
        weekTypeFilter.addEventListener('change', renderSchedule);
        
        // Initial data fetch and render
        db.collection("faculties").onSnapshot((snapshot) => {
            faculties = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            renderFacultyAndGroupFilters();
            renderFaculties();
            renderGroupFacultySelect();
        });

        db.collection("groups").onSnapshot((snapshot) => {
            groups = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            renderGroups();
            renderFacultyGroups(currentFacultyId);
            renderAvailableGroups();
            renderGroupSelect();
            renderFacultyAndGroupFilters();
            renderSchedule();
        });

        db.collection("schedule").onSnapshot((snapshot) => {
            schedule = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            renderSchedule();
            renderScheduleAdminList();
        });

    </script>

</body>
</html>
